{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
{% include 'includes/favicon.html' %}
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Test Results - {{ test.title }} | PulsePrep</title>
<link rel="stylesheet" href="{% static 'css/DAstyles.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

{% include 'includes/special_characters.html' %}

<style>
:root {
    --primary: #82272e;
    --primary-light: #a53b47;
    --primary-dark: #6b1e24;
    --secondary: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --info: #3b82f6;
    --light: #f8fafc;
    --dark: #1e293b;
    --gray: #64748b;
    --gray-light: #e2e8f0;
}

body {
    font-family: 'Inter', sans-serif;
    background-color: #f9fafb;
    color: var(--dark);
    line-height: 1.6;
}

/* Navigation Bar */
.nav-bar {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 16px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-bottom: 24px;
}

.nav-brand {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 18px;
    font-weight: 600;
}

.nav-brand img {
    height: 32px;
}

.nav-actions {
    display: flex;
    align-items: center;
    gap: 16px;
}

.nav-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    backdrop-filter: blur(10px);
    transition: all 0.2s;
    text-decoration: none;
}

.nav-btn:hover {
    background: rgba(255,255,255,0.3);
}

/* Result Container */
.result-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
}

/* Header */
.result-header {
    text-align: center;
    margin-bottom: 32px;
}

.result-header h1 {
    color: var(--dark);
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 8px;
}

.result-header p {
    color: var(--gray);
    font-size: 16px;
}

/* Summary Card */
.summary-card {
    background: white;
    border-radius: 16px;
    padding: 40px;
    margin-bottom: 32px;
    box-shadow: 0 8px 25px rgba(130, 39, 46, 0.1);
    text-align: center;
    border: 1px solid var(--gray-light);
}

.score-display {
    position: relative;
    width: 200px;
    height: 200px;
    margin: 0 auto 24px;
}

.score-circle {
    width: 100%;
    height: 100%;
}

.score-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 48px;
    font-weight: 700;
    color: var(--primary);
}

.pass-status {
    font-size: 20px;
    font-weight: 600;
    padding: 12px 24px;
    border-radius: 30px;
    display: inline-block;
    margin-bottom: 24px;
}

.pass-status.passed {
    background: #d1fae5;
    color: #065f46;
}

.pass-status.failed {
    background: #fecaca;
    color: #991b1b;
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 32px 0;
}

.stat-card {
    background: #f8fafc;
    padding: 24px;
    border-radius: 12px;
    text-align: center;
    border: 1px solid var(--gray-light);
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(130, 39, 46, 0.1);
}

.stat-value {
    font-size: 32px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 8px;
}

.stat-label {
    color: var(--gray);
    font-size: 14px;
    font-weight: 500;
}

.stat-icon {
    font-size: 20px;
    color: var(--primary);
    margin-bottom: 12px;
}

/* Performance Summary */
.performance-summary {
    background: white;
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 8px 25px rgba(130, 39, 46, 0.1);
    margin-bottom: 32px;
    border: 1px solid var(--gray-light);
}

.section-title {
    color: var(--dark);
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.section-title i {
    color: var(--primary);
}

.performance-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.performance-item {
    background: #f8fafc;
    padding: 20px;
    border-radius: 12px;
    border-left: 4px solid var(--primary);
}

.performance-item h4 {
    color: var(--dark);
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
}

.performance-item p {
    color: var(--gray);
    font-size: 14px;
    margin-bottom: 12px;
}

.performance-bar {
    background: #e2e8f0;
    height: 8px;
    border-radius: 4px;
    overflow: hidden;
}

.performance-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--primary-light));
    border-radius: 4px;
    transition: width 1s ease-in-out;
}

/* Review Section */
.review-section {
    background: white;
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 8px 25px rgba(130, 39, 46, 0.1);
    margin-bottom: 32px;
    border: 1px solid var(--gray-light);
}

.review-toggle {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
}

.review-toggle h2 {
    margin: 0;
    color: var(--dark);
    font-size: 20px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 12px;
}

.review-toggle h2 i {
    color: var(--primary);
}

.review-filters {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
}

.filter-btn {
    background: #f1f5f9;
    border: 2px solid transparent;
    color: var(--dark);
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
}

.filter-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.filter-btn:hover {
    background: var(--primary-light);
    color: white;
}

.toggle-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}

.toggle-btn:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
}

.question-review {
    border: 1px solid var(--gray-light);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    background: white;
    display: none;
}

.question-review.show {
    display: block;
}

.review-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--gray-light);
}

.question-number {
    font-weight: 600;
    color: var(--dark);
    font-size: 18px;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
}

.status-correct {
    background: #d1fae5;
    color: #065f46;
}

.status-incorrect {
    background: #fecaca;
    color: #991b1b;
}

.status-unanswered {
    background: #f3f4f6;
    color: #6b7280;
}

.question-text {
    font-size: 16px;
    line-height: 1.6;
    margin-bottom: 24px;
    color: var(--dark);
    font-weight: 500;
    padding: 16px;
    background: #f8fafc;
    border-radius: 8px;
    border-left: 4px solid var(--primary);
    white-space: pre-wrap;
}

/* ENHANCED: Image Display Styles */
.question-image, .explanation-image {
    margin: 16px 0;
    text-align: center;
    border-radius: 8px;
    overflow: hidden;
}

.question-image img, .explanation-image img {
    max-width: 100%;
    max-height: 400px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border: 1px solid var(--gray-light);
    transition: transform 0.2s ease;
    object-fit: contain;
    background: white;
    cursor: pointer;
}

.question-image img:hover, .explanation-image img:hover {
    transform: scale(1.02);
}

.image-caption {
    font-size: 12px;
    color: var(--gray);
    margin-top: 8px;
    font-style: italic;
}

.image-error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
    padding: 12px;
    border-radius: 8px;
    text-align: center;
    font-size: 14px;
    margin: 16px 0;
}

.image-error i {
    margin-right: 8px;
}

/* Image Modal for zoomed view */
.image-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 20px;
}

.image-modal img {
    max-width: 95%;
    max-height: 95%;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.5);
}

.image-modal-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255,255,255,0.2);
    color: white;
    border: none;
    padding: 10px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 20px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}

.mcq-options-section {
    margin-bottom: 24px;
}

.section-subtitle {
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 16px;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.options-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.option-item {
    margin-bottom: 12px;
}

.option-label {
    display: flex;
    align-items: center;
    padding: 16px;
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    transition: all 0.2s ease;
    min-height: 60px;
}

.option-label.correct {
    background: #d1fae5;
    border-color: var(--secondary);
    font-weight: 600;
}

.option-label.incorrect {
    background: #fecaca;
    border-color: var(--danger);
    font-weight: 600;
}

.option-label.selected {
    background: #fef3c7;
    border-color: var(--warning);
    font-weight: 500;
}

.option-label input[type="radio"] {
    margin-right: 16px;
    width: 18px;
    height: 18px;
    pointer-events: none;
    accent-color: var(--primary);
    flex-shrink: 0;
}

.option-text {
    font-size: 15px;
    line-height: 1.5;
    color: var(--dark);
    flex: 1;
    white-space: pre-wrap;
}

.option-icon {
    margin-left: 16px;
    font-size: 18px;
    width: 24px;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0;
}

.explanation-section {
    margin-top: 24px;
}

.explanation-box {
    background: #dbeafe;
    padding: 20px;
    border-radius: 12px;
    border-left: 4px solid var(--info);
}

.explanation-title {
    font-weight: 600;
    color: #1e40af;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px;
}

.explanation-text {
    font-size: 14px;
    line-height: 1.6;
    color: var(--dark);
    margin-bottom: 16px;
    white-space: pre-wrap;
}

/* Action Buttons */
.action-buttons {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 32px;
}

.btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    border: none;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(130, 39, 46, 0.3);
}

.btn-secondary {
    background: #f1f5f9;
    color: var(--dark);
    border: 1px solid var(--gray-light);
}

.btn-secondary:hover {
    background: #e2e8f0;
    transform: translateY(-2px);
}

.btn-success {
    background: var(--secondary);
    color: white;
}

.btn-success:hover {
    background: #059669;
    transform: translateY(-2px);
}

/* Back Warning Modal */
.back-warning-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(5px);
    padding: 20px;
}

.back-warning-content {
    background: white;
    padding: 24px;
    border-radius: 12px;
    text-align: center;
    max-width: 90vw;
    width: 440px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
}

.back-warning-content h2 {
    color: var(--danger);
    margin-bottom: 16px;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
}

.back-warning-content p {
    color: var(--gray);
    margin-bottom: 20px;
    font-size: 15px;
    line-height: 1.6;
}

.back-warning-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 20px;
    flex-wrap: wrap;
}

/* Responsive Design */
@media (max-width: 768px) {
    .result-container {
        padding: 16px;
    }

    .summary-card {
        padding: 24px;
    }

    .stats-grid {
        grid-template-columns: 1fr 1fr;
    }

    .review-section {
        padding: 24px;
    }

    .action-buttons {
        flex-direction: column;
        gap: 12px;
    }

    .btn {
        width: 100%;
        justify-content: center;
    }

    .nav-bar {
        padding: 12px 16px;
    }

    .nav-brand {
        font-size: 16px;
    }

    .nav-actions {
        gap: 8px;
    }

    .performance-grid {
        grid-template-columns: 1fr;
    }

    .review-toggle {
        flex-direction: column;
        align-items: stretch;
    }

    .review-filters {
        justify-content: center;
    }

    .back-warning-actions {
        flex-direction: column;
        gap: 8px;
    }

    .back-warning-actions .btn {
        width: 100%;
    }

    .question-image img, .explanation-image img {
        max-height: 250px;
    }
}

@media (max-width: 480px) {
    .result-container {
        padding: 16px;
    }

    .summary-card, .performance-summary, .review-section {
        padding: 16px;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .filter-btn {
        flex: 1;
        text-align: center;
    }

    .question-image img, .explanation-image img {
        max-height: 200px;
    }
}

/* Print Styles */
@media print {
    .no-print {
        display: none !important;
    }
    
    body {
        background: white !important;
        color: black !important;
        font-size: 12pt !important;
    }
    
    .result-container {
        max-width: none !important;
        margin: 0 !important;
        padding: 15pt !important;
    }
}

/* Animations */
.fade-in {
    animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.slide-down {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 1000px;
    }
}
</style>
</head>
<body>
{% include 'includes/security_protection.html' %}

<!-- Navigation Bar -->
<div class="nav-bar no-print">
<div class="nav-brand">
    <img src="{% static 'images/Logo.png' %}" alt="PulsePrep Logo" />
    Test Results
</div>
<div class="nav-actions">
    <button onclick="printSummary()" class="nav-btn">
        <i class="fas fa-print"></i> Print Summary
    </button>
    <a href="{% url 'student_dashboard' %}" class="nav-btn">
        <i class="fas fa-home"></i> Dashboard
    </a>
</div>
</div>

<div class="result-container">
<!-- Result Header -->
<div class="result-header">
    <h1>{{ test.title }}</h1>
    <p>Test completed on {{ attempt.started_at|date:"F j, Y" }} at {{ attempt.started_at|time:"g:i A" }}</p>
</div>

<!-- Summary Card -->
<div class="summary-card fade-in">
    <div class="score-display">
        <canvas id="scoreChart" class="score-circle" width="200" height="200"></canvas>
        <div class="score-text">{{ attempt.percentage|floatformat:0 }}%</div>
    </div>

    <div class="pass-status {% if passed %}passed{% else %}failed{% endif %}">
        <i class="fas fa-{% if passed %}check{% else %}times{% endif %}-circle"></i>
        {% if passed %}PASSED{% else %}FAILED{% endif %}
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-value">{{ attempt.score }}</div>
            <div class="stat-label">Correct Answers</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-question-circle"></i>
            </div>
            <div class="stat-value">{{ total_questions }}</div>
            <div class="stat-label">Total Questions</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-value">{{ attempt.time_taken_display }}</div>
            <div class="stat-label">Time Taken</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-trophy"></i>
            </div>
            <div class="stat-value">{{ test.passing_percentage }}%</div>
            <div class="stat-label">Passing Score</div>
        </div>
    </div>
</div>

<!-- Performance Summary -->
<div class="performance-summary fade-in">
    <h2 class="section-title">
        <i class="fas fa-chart-line"></i>
        Performance Analysis
    </h2>
    
    <div class="performance-grid">
        <div class="performance-item">
            <h4>Overall Score</h4>
            <p>Your performance in this test</p>
            <div class="performance-bar">
                <div class="performance-fill" style="width: {{ attempt.percentage }}%"></div>
            </div>
            <small>{{ attempt.percentage|floatformat:1 }}% ({{ attempt.score }}/{{ total_questions }})</small>
        </div>
        
        <div class="performance-item">
            <h4>Time Efficiency</h4>
            <p>How efficiently you used the time</p>
            <div class="performance-bar">
                <div class="performance-fill" style="width: {% widthratio attempt.time_taken test.duration_minutes 100 %}%"></div>
            </div>
            <small>{{ attempt.time_taken_formatted }} of {{ test.duration_minutes }} minutes used</small>
        </div>
        
        <div class="performance-item">
            <h4>Accuracy Rate</h4>
            <p>Percentage of attempted questions correct</p>
            <div class="performance-bar">
                <div class="performance-fill" style="width: {{ attempt.percentage }}%"></div>
            </div>
            <small>{{ attempt.percentage|floatformat:1 }}% accuracy</small>
        </div>
        
        <div class="performance-item">
            <h4>Completion Status</h4>
            <p>Test completion and submission</p>
            <div class="performance-bar">
                <div class="performance-fill" style="width: 100%"></div>
            </div>
            <small>Test completed successfully</small>
        </div>
    </div>
</div>

<!-- Test Information -->
<div class="performance-summary fade-in">
    <h2 class="section-title">
        <i class="fas fa-info-circle"></i>
        Test Information
    </h2>
    
    <div class="performance-grid">
        <div class="performance-item">
            <h4>Test Details</h4>
            <p><strong>Subject:</strong> {{ test.subject|default:"General" }}</p>
            <p><strong>Duration:</strong> {{ test.duration_minutes }} minutes</p>
            <p><strong>Total Questions:</strong> {{ total_questions }}</p>
            <p><strong>Passing Score:</strong> {{ test.passing_percentage }}%</p>
        </div>
        
        <div class="performance-item">
            <h4>Attempt Details</h4>
            <p><strong>Started:</strong> {{ attempt.started_at|date:"M j, Y g:i A" }}</p>
            <p><strong>Submitted:</strong> {{ attempt.completed_at|date:"M j, Y g:i A" }}</p>
            <p><strong>Time Taken:</strong> {{ attempt.time_taken_formatted }}</p>
            <p><strong>Warnings:</strong> {{ attempt.warning_count }}</p>
        </div>
        
        <div class="performance-item">
            <h4>Student Information</h4>
            <p><strong>Name:</strong> {{ user.get_full_name|default:"N/A" }}</p>
            <p><strong>Email:</strong> {{ user.email }}</p>
            {% if user.student_id %}
            <p><strong>Student ID:</strong> {{ user.student_id }}</p>
            {% endif %}
            <p><strong>Course:</strong> {{ user.degree|default:"N/A" }}</p>
        </div>
        
        <div class="performance-item">
            <h4>Result Summary</h4>
            <p><strong>Status:</strong> 
                <span style="color: {% if passed %}#065f46{% else %}#991b1b{% endif %};">
                    {% if passed %}PASSED{% else %}FAILED{% endif %}
                </span>
            </p>
            <p><strong>Score:</strong> {{ attempt.percentage|floatformat:1 }}%</p>
            <p><strong>Grade:</strong> 
                {% if attempt.percentage >= 90 %}A+
                {% elif attempt.percentage >= 80 %}A
                {% elif attempt.percentage >= 70 %}B
                {% elif attempt.percentage >= 60 %}C
                {% elif attempt.percentage >= 50 %}D
                {% else %}F
                {% endif %}
            </p>
        </div>
    </div>
</div>

<!-- Enhanced Answers Review -->
{% if test.show_explanations %}
<div class="review-section fade-in no-print">
    <div class="review-toggle">
        <h2 class="section-title">
            <i class="fas fa-clipboard-check"></i>
            Detailed Answers Review
        </h2>
        
        <div class="review-filters">
            <button class="filter-btn active" onclick="filterQuestions('all')" id="filter-all">
                <i class="fas fa-list"></i> All Questions
            </button>
            <button class="filter-btn" onclick="filterQuestions('correct')" id="filter-correct">
                <i class="fas fa-check"></i> Correct Only
            </button>
            <button class="filter-btn" onclick="filterQuestions('incorrect')" id="filter-incorrect">
                <i class="fas fa-times"></i> Incorrect Only
            </button>
            <button class="filter-btn" onclick="filterQuestions('unanswered')" id="filter-unanswered">
                <i class="fas fa-question"></i> Unanswered
            </button>
        </div>
        
        <button class="toggle-btn" onclick="toggleReview()">
            <i class="fas fa-eye" id="toggle-icon"></i>
            <span id="toggle-text">Show Answers</span>
        </button>
    </div>
    
    <div id="review-content">
        {% for response in responses %}
            <div class="question-review" data-status="{% if not response.selected_answer %}unanswered{% elif response.is_correct %}correct{% else %}incorrect{% endif %}">
                <div class="review-header">
                    <div class="question-number">Question {{ forloop.counter }}</div>
                    <span class="status-badge {% if not response.selected_answer %}status-unanswered{% elif response.is_correct %}status-correct{% else %}status-incorrect{% endif %}">
                        <i class="fas fa-{% if not response.selected_answer %}question{% elif response.is_correct %}check{% else %}times{% endif %}"></i>
                        {% if not response.selected_answer %}Unanswered{% elif response.is_correct %}Correct{% else %}Incorrect{% endif %}
                    </span>
                </div>
                
                <div class="question-text">{{ response.question.question_text }}</div>
                
                <!-- ENHANCED: Question Image Display -->
                {% if response.question_image_url %}
                    <div class="question-image">
                        <img src="{{ response.question_image_url }}" 
                             alt="Question {{ forloop.counter }} Image" 
                             loading="lazy"
                             onclick="openImageModal('{{ response.question_image_url }}')"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div class="image-error" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Image not found: {{ response.question_image_filename }}</span>
                        </div>
                        {% if response.question_image_filename %}
                            <div class="image-caption">Question Image: {{ response.question_image_filename }}</div>
                        {% endif %}
                    </div>
                {% endif %}
                
                <!-- MCQ Options Section -->
                <div class="mcq-options-section">
                    <div class="section-subtitle">
                        <i class="fas fa-list-ol"></i>
                        Answer Options
                    </div>
                    <ul class="options-list">
                        {% if response.question.option_a %}
                            <li class="option-item">
                                <label class="option-label 
                                    {% if response.question.correct_answer == 'A' %}correct{% endif %}
                                    {% if response.selected_answer == 'A' and not response.is_correct %}incorrect{% endif %}
                                    {% if response.selected_answer == 'A' %}selected{% endif %}">
                                    <input type="radio" name="q{{ forloop.counter }}" value="A" 
                                        {% if response.selected_answer == 'A' %}checked{% endif %}>
                                    <span class="option-text">A) {{ response.question.option_a }}</span>
                                    {% if response.question.correct_answer == 'A' %}
                                        <i class="fas fa-check option-icon" style="color: #065f46;"></i>
                                    {% elif response.selected_answer == 'A' and not response.is_correct %}
                                        <i class="fas fa-times option-icon" style="color: #991b1b;"></i>
                                    {% endif %}
                                </label>
                            </li>
                        {% endif %}
                        
                        {% if response.question.option_b %}
                            <li class="option-item">
                                <label class="option-label 
                                    {% if response.question.correct_answer == 'B' %}correct{% endif %}
                                    {% if response.selected_answer == 'B' and not response.is_correct %}incorrect{% endif %}
                                    {% if response.selected_answer == 'B' %}selected{% endif %}">
                                    <input type="radio" name="q{{ forloop.counter }}" value="B" 
                                        {% if response.selected_answer == 'B' %}checked{% endif %}>
                                    <span class="option-text">B) {{ response.question.option_b }}</span>
                                    {% if response.question.correct_answer == 'B' %}
                                        <i class="fas fa-check option-icon" style="color: #065f46;"></i>
                                    {% elif response.selected_answer == 'B' and not response.is_correct %}
                                        <i class="fas fa-times option-icon" style="color: #991b1b;"></i>
                                    {% endif %}
                                </label>
                            </li>
                        {% endif %}
                        
                        {% if response.question.option_c %}
                            <li class="option-item">
                                <label class="option-label 
                                    {% if response.question.correct_answer == 'C' %}correct{% endif %}
                                    {% if response.selected_answer == 'C' and not response.is_correct %}incorrect{% endif %}
                                    {% if response.selected_answer == 'C' %}selected{% endif %}">
                                    <input type="radio" name="q{{ forloop.counter }}" value="C" 
                                        {% if response.selected_answer == 'C' %}checked{% endif %}>
                                    <span class="option-text">C) {{ response.question.option_c }}</span>
                                    {% if response.question.correct_answer == 'C' %}
                                        <i class="fas fa-check option-icon" style="color: #065f46;"></i>
                                    {% elif response.selected_answer == 'C' and not response.is_correct %}
                                        <i class="fas fa-times option-icon" style="color: #991b1b;"></i>
                                    {% endif %}
                                </label>
                            </li>
                        {% endif %}
                        
                        {% if response.question.option_d %}
                            <li class="option-item">
                                <label class="option-label 
                                    {% if response.question.correct_answer == 'D' %}correct{% endif %}
                                    {% if response.selected_answer == 'D' and not response.is_correct %}incorrect{% endif %}
                                    {% if response.selected_answer == 'D' %}selected{% endif %}">
                                    <input type="radio" name="q{{ forloop.counter }}" value="D" 
                                        {% if response.selected_answer == 'D' %}checked{% endif %}>
                                    <span class="option-text">D) {{ response.question.option_d }}</span>
                                    {% if response.question.correct_answer == 'D' %}
                                        <i class="fas fa-check option-icon" style="color: #065f46;"></i>
                                    {% elif response.selected_answer == 'D' and not response.is_correct %}
                                        <i class="fas fa-times option-icon" style="color: #991b1b;"></i>
                                    {% endif %}
                                </label>
                            </li>
                        {% endif %}
                        
                        {% if response.question.option_e %}
                            <li class="option-item">
                                <label class="option-label 
                                    {% if response.question.correct_answer == 'E' %}correct{% endif %}
                                    {% if response.selected_answer == 'E' and not response.is_correct %}incorrect{% endif %}
                                    {% if response.selected_answer == 'E' %}selected{% endif %}">
                                    <input type="radio" name="q{{ forloop.counter }}" value="E" 
                                        {% if response.selected_answer == 'E' %}checked{% endif %}>
                                    <span class="option-text">E) {{ response.question.option_e }}</span>
                                    {% if response.question.correct_answer == 'E' %}
                                        <i class="fas fa-check option-icon" style="color: #065f46;"></i>
                                    {% elif response.selected_answer == 'E' and not response.is_correct %}
                                        <i class="fas fa-times option-icon" style="color: #991b1b;"></i>
                                    {% endif %}
                                </label>
                            </li>
                        {% endif %}
                    </ul>
                </div>
                
                <!-- Explanation Section -->
                {% if response.question.explanation %}
                    <div class="explanation-section">
                        <div class="explanation-box">
                            <div class="explanation-title">
                                <i class="fas fa-lightbulb"></i>
                                Explanation
                            </div>
                            <div class="explanation-text">{{ response.question.explanation }}</div>
                            
                            <!-- ENHANCED: Explanation Image Display -->
                            {% if response.explanation_image_url %}
                                <div class="explanation-image">
                                    <img src="{{ response.explanation_image_url }}" 
                                         alt="Question {{ forloop.counter }} Explanation Image" 
                                         loading="lazy"
                                         onclick="openImageModal('{{ response.explanation_image_url }}')"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <div class="image-error" style="display: none;">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <span>Image not found: {{ response.explanation_image_filename }}</span>
                                    </div>
                                    {% if response.explanation_image_filename %}
                                        <div class="image-caption">Explanation Image: {{ response.explanation_image_filename }}</div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Action Buttons -->
<div class="action-buttons no-print">
    <a href="{% url 'student_mock_tests' %}" class="btn btn-secondary">
        <i class="fas fa-vial"></i> Take Another Test
    </a>
    <button onclick="printSummary()" class="btn btn-success">
        <i class="fas fa-print"></i> Print Summary
    </button>
    <a href="{% url 'student_dashboard' %}" class="btn btn-primary">
        <i class="fas fa-home"></i> Back to Dashboard
    </a>
</div>
</div>

<!-- Back Button Prevention Modal -->
<div class="back-warning-modal" id="back-warning-modal">
<div class="back-warning-content">
    <h2><i class="fas fa-exclamation-triangle"></i> Navigation Warning</h2>
    <p><strong>You cannot go back to the test once submitted.</strong></p>
    <p>The test has been completed and submitted. Going back is not allowed for security reasons.</p>
    <p>Would you like to go to the dashboard instead?</p>
    <div class="back-warning-actions">
        <button class="btn btn-secondary" onclick="closeBackWarning()">Stay Here</button>
        <a href="{% url 'student_dashboard' %}" class="btn btn-primary">
            <i class="fas fa-home"></i> Go to Dashboard
        </a>
    </div>
</div>
</div>

<!-- ENHANCED: Image Modal for zoomed view -->
<div class="image-modal" id="image-modal">
    <button class="image-modal-close" onclick="closeImageModal()">
        <i class="fas fa-times"></i>
    </button>
    <img id="modal-image" src="" alt="Zoomed Image">
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Enhanced back button prevention
window.addEventListener('load', function() {
    window.history.replaceState(null, null, window.location.href);
    
    window.addEventListener('popstate', function(event) {
        event.preventDefault();
        window.history.pushState(null, null, window.location.href);
        showBackWarning();
    });
    
    window.history.pushState(null, null, window.location.href);
});

function showBackWarning() {
    document.getElementById('back-warning-modal').style.display = 'flex';
}

function closeBackWarning() {
    document.getElementById('back-warning-modal').style.display = 'none';
}

// Draw score chart
const ctx = document.getElementById('scoreChart').getContext('2d');
const percentage = {{ attempt.percentage }};
const passingPercentage = {{ test.passing_percentage }};

new Chart(ctx, {
    type: 'doughnut',
    data: {
        datasets: [{
            data: [percentage, 100 - percentage],
            backgroundColor: [
                percentage >= passingPercentage ? '#10b981' : '#ef4444',
                '#e5e7eb'
            ],
            borderWidth: 0
        }]
    },
    options: {
        cutout: '75%',
        rotation: -90,
        circumference: 180,
        plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
        },
        animation: {
            animateScale: true,
            animateRotate: true,
            duration: 1500
        }
    }
});

// ENHANCED: Image modal functions
function openImageModal(imageUrl) {
    const modal = document.getElementById('image-modal');
    const modalImage = document.getElementById('modal-image');
    
    modalImage.src = imageUrl;
    modal.style.display = 'flex';
    
    // Prevent body scroll
    document.body.style.overflow = 'hidden';
}

function closeImageModal() {
    const modal = document.getElementById('image-modal');
    modal.style.display = 'none';
    
    // Restore body scroll
    document.body.style.overflow = 'auto';
}

// Close modal when clicking outside image
document.getElementById('image-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeImageModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const imageModal = document.getElementById('image-modal');
        if (imageModal.style.display === 'flex') {
            closeImageModal();
        }
    }
});

// Review functionality
let reviewVisible = false;
let currentFilter = 'all';

function toggleReview() {
    const reviewContent = document.getElementById('review-content');
    const toggleIcon = document.getElementById('toggle-icon');
    const toggleText = document.getElementById('toggle-text');
    
    reviewVisible = !reviewVisible;
    
    if (reviewVisible) {
        showQuestionsWithFilter(currentFilter);
        toggleIcon.className = 'fas fa-eye-slash';
        toggleText.textContent = 'Hide Answers';
    } else {
        hideAllQuestions();
        toggleIcon.className = 'fas fa-eye';
        toggleText.textContent = 'Show Answers';
    }
}

function filterQuestions(filter) {
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById(`filter-${filter}`).classList.add('active');
    
    currentFilter = filter;
    
    if (reviewVisible) {
        showQuestionsWithFilter(filter);
    }
}

function showQuestionsWithFilter(filter) {
    const questions = document.querySelectorAll('.question-review');
    let delay = 0;
    
    questions.forEach((question, index) => {
        const status = question.getAttribute('data-status');
        let shouldShow = false;
        
        switch(filter) {
            case 'all':
                shouldShow = true;
                break;
            case 'correct':
                shouldShow = status === 'correct';
                break;
            case 'incorrect':
                shouldShow = status === 'incorrect';
                break;
            case 'unanswered':
                shouldShow = status === 'unanswered';
                break;
        }
        
        if (shouldShow) {
            setTimeout(() => {
                question.classList.add('show', 'slide-down');
            }, delay);
            delay += 100;
        } else {
            question.classList.remove('show', 'slide-down');
        }
    });
}

function hideAllQuestions() {
    const questions = document.querySelectorAll('.question-review');
    questions.forEach(question => {
        question.classList.remove('show', 'slide-down');
    });
}

// Enhanced Print Summary Function - Bypasses Security
function printSummary() {
    // Store original security state
    const originalSecureClass = document.body.classList.contains('secure-content');
    const reviewSection = document.querySelector('.review-section');
    const originalDisplay = reviewSection ? reviewSection.style.display : '';
    
    // Temporarily disable security for printing
    if (originalSecureClass) {
        document.body.classList.remove('secure-content');
    }
    
    // Hide review section as before
    if (reviewSection) {
        reviewSection.style.display = 'none';
    }
    
    // Create a temporary style override for print
    const printStyle = document.createElement('style');
    printStyle.id = 'temp-print-style';
    printStyle.textContent = `
        @media print {
            body::before {
                display: none !important;
            }
            .secure-content {
                display: block !important;
                -webkit-user-select: text !important;
                -moz-user-select: text !important;
                -ms-user-select: text !important;
                user-select: text !important;
            }
            .no-print {
                display: none !important;
            }
        }
    `;
    document.head.appendChild(printStyle);
    
    // Print the page
    window.print();
    
    // Restore everything after print dialog
    setTimeout(() => {
        // Remove temporary print styles
        const tempStyle = document.getElementById('temp-print-style');
        if (tempStyle) {
            tempStyle.remove();
        }
        
        // Restore security class if it was originally present
        if (originalSecureClass) {
            document.body.classList.add('secure-content');
        }
        
        // Restore review section display
        if (reviewSection) {
            reviewSection.style.display = originalDisplay;
        }
    }, 1000); // Wait 1 second for print dialog to process
}

// Animate performance bars on load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        const performanceFills = document.querySelectorAll('.performance-fill');
        performanceFills.forEach(fill => {
            const width = fill.style.width;
            fill.style.width = '0%';
            setTimeout(() => {
                fill.style.width = width;
            }, 300);
        });
    }, 500);
});

// Enhanced browser navigation prevention
document.addEventListener('keydown', function(e) {
    if (e.altKey && (e.key === 'ArrowLeft' || e.key === 'ArrowRight')) {
        e.preventDefault();
        showBackWarning();
    }
    
    if (e.key === 'Backspace' && 
        !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName) &&
        !document.activeElement.isContentEditable) {
        e.preventDefault();
        showBackWarning();
    }
});

document.addEventListener('mouseup', function(e) {
    if (e.button === 3 || e.button === 4) {
        e.preventDefault();
        showBackWarning();
    }
});

// Touch gesture prevention for mobile
if ('ontouchstart' in window) {
    let lastTouchEnd = 0;
    
    document.addEventListener('touchend', function (event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault();
        }
        lastTouchEnd = now;
    }, false);
    
    document.addEventListener('gesturestart', function (e) {
        e.preventDefault();
    });
    
    document.addEventListener('gesturechange', function (e) {
        e.preventDefault();
    });
    
    document.addEventListener('gestureend', function (e) {
        e.preventDefault();
    });
}
</script>
</body>
</html>