{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    {% include 'includes/favicon.html' %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PulsePrep - Manage Images</title>
    <link rel="stylesheet" href="{% static 'css/DAstyles.css' %}" />
    <link rel="stylesheet" href="{% static 'css/MQstyles.css' %}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="container">
      
<!-- Sidebar Navigation -->
<aside class="sidebar">
  <div class="logo-container">
    <img src="{% static 'images/Logo.png' %}" alt="PulsePrep Logo" class="logo" />
  </div>
  <nav class="nav-menu">
    <a href="{% url 'dashboard' %}" class="nav-item {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
      <i class="fas fa-th-large"></i>
      <span>Dashboard</span>
    </a>
    <a href="{% url 'questionbank' %}" class="nav-item {% if request.resolver_match.url_name == 'questionbank' %}active{% endif %}">
      <i class="fas fa-question-circle"></i>
      <span>Manage Questions</span>
    </a>
    <a href="{% url 'manage_csv' %}" class="nav-item {% if request.resolver_match.url_name == 'manage_csv' %}active{% endif %}">
      <i class="fas fa-file-csv"></i>
      <span>Manage CSVs</span>
    </a>

    <a href="{% url 'manage_images' %}" class="nav-item {% if request.resolver_match.url_name == 'manage_images' %}active{% endif %}">
      <i class="fas fa-images"></i>
      <span>Manage Images</span>
    </a>
    
    <a href="{% url 'managemodule' %}" class="nav-item {% if request.resolver_match.url_name == 'managemodule' %}active{% endif %}">
      <i class="fas fa-cubes"></i>
      <span>Modules</span>
    </a>
    <a href="/admin/user_management/customuser/" class="nav-item">
      <i class="fas fa-users"></i>
      <span>Manage Users</span>
    </a>
    <a href="{% url 'mocktest_list' %}" class="nav-item {% if request.resolver_match.url_name == 'mocktest_list' %}active{% endif %}">
      <i class="fas fa-vial"></i>
      <span>Mock Tests</span>
    </a>
    <a href="{% url 'modelpaper_list' %}" class="nav-item {% if request.resolver_match.url_name == 'modelpaper_list' %}active{% endif %}">
      <i class="fas fa-file-alt"></i>
      <span>Model Papers</span>
    </a>
    <a href="{% url 'analytics_report' %}" class="nav-item {% if request.resolver_match.url_name == 'analytics_report' %}active{% endif %}">
      <i class="fas fa-chart-bar"></i>
      <span>Analytics & Reports</span>
    </a>
    <a href="{% url 'myaccount' %}" class="nav-item {% if request.resolver_match.url_name == 'myaccount' %}active{% endif %}">
      <i class="fas fa-user"></i>
      <span>My Account</span>
    </a>
    <a href="{% url 'notification_center' %}" class="nav-item {% if request.resolver_match.url_name == 'notification_center' %}active{% endif %}">
      <i class="fas fa-bell"></i>
      <span>Notifications</span>
      <span class="notification-badge-sidebar"></span>
    </a>
    <a href="{% url 'logout' %}" class="nav-item">
      <i class="fas fa-sign-out-alt"></i>
      <span>Logout</span>
    </a>
  </nav>
</aside>

      <!-- Main Content -->
      <main class="main-content">
        <header class="header">
          <div class="mobile-menu">
            <button id="sidebar-toggle">
              <i class="fas fa-bars"></i>
            </button>
          </div>
          <h1>
            <i class="fas fa-images"></i>
            Manage Images
          </h1>
          <div class="user-menu">
            <a href="{% url 'notification_center' %}"><i class="fas fa-bell"></i></a>
            <div class="avatar">
              <img src="https://i.pravatar.cc/40?img=12" alt="User Avatar" />
            </div>
          </div>
        </header>

        <!-- Image Management Content -->
        <div class="dashboard-content">
          <div class="image-management-container">
            
            <!-- Breadcrumb Navigation -->
            <div class="breadcrumb-nav">
              <a href="{% url 'questionbank' %}" class="breadcrumb-link">
                <i class="fas fa-question-circle"></i> Questions
              </a>
              <i class="fas fa-chevron-right"></i>
              <span class="breadcrumb-current">
                Image Management
              </span>
            </div>

            <!-- Messages -->
            {% if messages %}
              <div class="messages">
                {% for message in messages %}
                  <div class="message {% if message.tags %}{{ message.tags }}{% endif %}">
                    {% if message.tags == 'success' %}
                      <i class="fas fa-check-circle"></i>
                    {% elif message.tags == 'error' %}
                      <i class="fas fa-exclamation-circle"></i>
                    {% elif message.tags == 'warning' %}
                      <i class="fas fa-exclamation-triangle"></i>
                    {% else %}
                      <i class="fas fa-info-circle"></i>
                    {% endif %}
                    {{ message }}
                  </div>
                {% endfor %}
              </div>
            {% endif %}
            
            <!-- Statistics Section -->
            <div class="stats-section">
              <h2><i class="fas fa-chart-bar"></i> Image Statistics</h2>
              <p class="section-description">
                Overview of your image library for 
                {% if stats.modelpaper_available %}
                  Question Bank and Model Papers
                {% else %}
                  Question Bank
                {% endif %}
              </p>
              
              <div class="stats-cards">
                <div class="stat-card">
                  <div class="stat-icon">
                    <i class="fas fa-images"></i>
                  </div>
                  <div class="stat-content">
                    <h3>{{ stats.total_images|default:"0" }}</h3>
                    <p>Total Images</p>
                  </div>
                </div>
                
                <div class="stat-card success">
                  <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                  </div>
                  <div class="stat-content">
                    <h3>{{ stats.used_images|default:"0" }}</h3>
                    <p>Used in Questions</p>
                    {% if stats.modelpaper_available %}
                      <small>QB: {{ stats.questionbank_usage|default:"0" }} | MP: {{ stats.modelpaper_usage|default:"0" }}</small>
                    {% else %}
                      <small>Question Bank Only</small>
                    {% endif %}
                  </div>
                </div>
                
                <div class="stat-card warning">
                  <div class="stat-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                  </div>
                  <div class="stat-content">
                    <h3>{{ stats.unused_images|default:"0" }}</h3>
                    <p>Unused Images</p>
                  </div>
                </div>
                
                <div class="stat-card">
                  <div class="stat-icon">
                    <i class="fas fa-percentage"></i>
                  </div>
                  <div class="stat-content">
                    <h3>{{ stats.usage_percentage|default:"0" }}%</h3>
                    <p>Usage Rate</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Upload Section -->
            <div class="upload-section">
              <h2><i class="fas fa-cloud-upload-alt"></i> Upload Images</h2>
              <p class="section-description">
                Upload images for use in 
                {% if stats.modelpaper_available %}
                  Question Bank questions and Model Paper questions
                {% else %}
                  Question Bank questions
                {% endif %}
              </p>
              
              <div class="upload-area" id="upload-area">
                <div class="upload-icon">
                  <i class="fas fa-images"></i>
                </div>
                <h3>Drag & Drop Images Here</h3>
                <p>or <button type="button" class="browse-link">browse files</button></p>
                <input type="file" id="file-input" accept="image/*" multiple style="display: none;">
                
                <div class="file-requirements">
                  <h4><i class="fas fa-info-circle"></i> Requirements:</h4>
                  <ul>
                    <li><strong>Format:</strong> JPG, PNG, GIF, WebP</li>
                    <li><strong>Size:</strong> Maximum 5MB per image</li>
                    <li><strong>Usage:</strong> Reference by filename in CSV</li>
                    <li><strong>Names:</strong> Use descriptive filenames</li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Bulk Actions Section -->
            <div class="bulk-actions">
              <button class="btn-secondary" id="select-all-btn">
                <i class="fas fa-check-square"></i> Select All
              </button>
              <button class="btn-danger" id="bulk-delete-btn" disabled>
                <i class="fas fa-trash"></i> Delete Selected
              </button>
              <span id="selected-count">0 selected</span>
            </div>

            <!-- Search and Filter Section -->
            <div class="controls-section">
              <form method="GET" class="search-controls">
                <div class="search-container">
                  <input
                    type="text"
                    placeholder="Search images by filename..."
                    class="search-input"
                    name="q"
                    value="{{ query }}"
                  />
                  <i class="fas fa-search search-icon"></i>
                </div>
                <select name="usage" class="filter-select">
                  <option value="">All Images</option>
                  <option value="used" {% if usage_filter == 'used' %}selected{% endif %}>Used Images</option>
                  <option value="unused" {% if usage_filter == 'unused' %}selected{% endif %}>Unused Images</option>
                  <option value="questionbank" {% if usage_filter == 'questionbank' %}selected{% endif %}>QuestionBank Only</option>
                  {% if stats.modelpaper_available %}
                    <option value="modelpaper" {% if usage_filter == 'modelpaper' %}selected{% endif %}>Model Paper Only</option>
                  {% endif %}
                </select>
                <select name="sort" class="filter-select">
                  <option value="-uploaded_at" {% if sort_by == '-uploaded_at' %}selected{% endif %}>Newest First</option>
                  <option value="uploaded_at" {% if sort_by == 'uploaded_at' %}selected{% endif %}>Oldest First</option>
                  <option value="filename" {% if sort_by == 'filename' %}selected{% endif %}>Name A-Z</option>
                  <option value="-filename" {% if sort_by == '-filename' %}selected{% endif %}>Name Z-A</option>
                  <option value="-file_size" {% if sort_by == '-file_size' %}selected{% endif %}>Largest First</option>
                  <option value="file_size" {% if sort_by == 'file_size' %}selected{% endif %}>Smallest First</option>
                </select>
                <button type="submit" class="btn-secondary">
                  <i class="fas fa-filter"></i> Apply
                </button>
                {% if query or usage_filter or sort_by != '-uploaded_at' %}
                  <a href="{% url 'manage_images' %}" class="btn-clear">
                    <i class="fas fa-times"></i> Clear
                  </a>
                {% endif %}
              </form>
              
              <div class="view-controls">
                <span class="results-count">{{ total_images }} images found</span>
                <div class="view-options">
                  <button class="view-btn active" data-view="grid" title="Grid View">
                    <i class="fas fa-th"></i>
                  </button>
                  <button class="view-btn" data-view="list" title="List View">
                    <i class="fas fa-list"></i>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Images Grid/List -->
            <div class="images-container">
              {% if page_obj %}
                <div class="images-grid" id="images-grid">
                  {% for image in page_obj %}
                    <div class="image-card" data-image-id="{{ image.id }}">
                      <!-- FIXED: Added missing checkbox for bulk selection -->
                      <div class="image-checkbox">
                        <input type="checkbox" class="image-checkbox-input" data-image-id="{{ image.id }}">
                      </div>
                      
                      <div class="image-preview">
                        <img src="{{ image.image.url }}" alt="{{ image.filename }}" loading="lazy" 
                             onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'image-error\'><i class=\'fas fa-exclamation-triangle\'></i><br>Image not found<br><small>{{ image.filename }}</small></div>';">
                        <div class="image-overlay">
                          <button class="btn-icon view-usage-btn" title="View Usage" onclick="viewImageUsage({{ image.id }})">
                            <i class="fas fa-eye"></i>
                          </button>
                          <button class="btn-icon delete-btn" title="Delete Image" onclick="deleteImage({{ image.id }}, '{{ image.filename }}')">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </div>
                      <div class="image-info">
                        <div class="image-name">{{ image.filename }}</div>
                        <div class="image-meta">
                          <span class="image-size">{{ image.file_size_formatted }}</span>
                          <span class="image-date">{{ image.uploaded_at|date:"M d, Y" }}</span>
                        </div>
                        <div class="image-usage" id="usage-{{ image.id }}">
                          <i class="fas fa-spinner fa-spin"></i> Loading...
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
                
                <!-- Pagination -->
                {% if page_obj.has_other_pages %}
                  <div class="pagination-container">
                    <div class="pagination">
                      {% if page_obj.has_previous %}
                        <a href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if usage_filter %}&usage={{ usage_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}" class="page-link">
                          <i class="fas fa-chevron-left"></i>
                        </a>
                      {% endif %}
                      
                      {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                          <span class="page-link active">{{ num }}</span>
                        {% else %}
                          <a href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if usage_filter %}&usage={{ usage_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}" class="page-link">{{ num }}</a>
                        {% endif %}
                      {% endfor %}
                      
                      {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if usage_filter %}&usage={{ usage_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}" class="page-link">
                          <i class="fas fa-chevron-right"></i>
                        </a>
                      {% endif %}
                    </div>
                  </div>
                {% endif %}
                
              {% else %}
                <div class="no-images">
                  <div class="no-images-content">
                    <i class="fas fa-images"></i>
                    <h3>No Images Found</h3>
                    {% if query %}
                      <p>No images match your search "{{ query }}". Try a different search term.</p>
                    {% elif usage_filter %}
                      <p>No images match the selected filter. Try a different filter option.</p>
                    {% else %}
                      <p>Start by uploading your first images above.</p>
                    {% endif %}
                    <a href="{% url 'manage_images' %}" class="btn-secondary">
                      <i class="fas fa-arrow-left"></i> View All Images
                    </a>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
        
        <!-- Footer -->
        <footer class="footer">
          <div class="social-links">
            <a href="#" title="Facebook"><i class="fab fa-facebook-f"></i></a>
            <a href="#" title="Twitter"><i class="fab fa-twitter"></i></a>
            <a href="#" title="Instagram"><i class="fab fa-instagram"></i></a>
          </div>
          <div class="copyright">
            &copy; {{ current_year|default:"2024" }} PulsePrep Media Direct, LLC. All rights reserved.
          </div>
        </footer>
      </main>
    </div>

    <!-- Upload Progress Modal -->
    <div id="upload-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-cloud-upload-alt"></i> Uploading Images</h3>
        </div>
        <div class="modal-body">
          <div class="progress-bar">
            <div class="progress-fill" id="upload-progress-fill"></div>
          </div>
          <div class="progress-info">
            <span class="progress-text" id="upload-status">Processing files...</span>
            <span class="progress-percentage" id="upload-percentage">0%</span>
          </div>
          <div id="upload-details"></div>
        </div>
      </div>
    </div>

    <!-- Image Usage Modal -->
    <div id="usage-modal" class="modal" style="display: none;">
      <div class="modal-content large">
        <div class="modal-header">
          <h3><i class="fas fa-eye"></i> Image Usage Details</h3>
          <button class="close-modal" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
          <div id="usage-content">
            <!-- Dynamic content will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-exclamation-triangle"></i> Confirm Delete</h3>
          <button class="close-modal" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete this image?</p>
          <p><strong id="delete-filename"></strong></p>
          <p class="warning-text">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary close-modal">Cancel</button>
          <button class="btn-danger" id="confirm-delete-btn">Delete Image</button>
        </div>
      </div>
    </div>

    <script src="{% static 'js/DAscript.js' %}"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // File upload handling
        setupFileUpload();
        loadImageUsage();

        // Bulk delete functionality
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
        const selectAllBtn = document.getElementById('select-all-btn');
        const selectedCountSpan = document.getElementById('selected-count');
        let selectedImages = new Set();
        let allSelected = false;

        // Toggle selection for individual images
        document.addEventListener('click', function(e) {
          if (e.target.classList.contains('image-checkbox-input')) {
            const imageId = e.target.dataset.imageId;
            
            if (e.target.checked) {
              selectedImages.add(imageId);
            } else {
              selectedImages.delete(imageId);
              allSelected = false;
              selectAllBtn.innerHTML = '<i class="fas fa-check-square"></i> Select All';
            }
            
            updateSelectionUI();
          }
        });

        // Select all/deselect all
        selectAllBtn.addEventListener('click', function() {
          allSelected = !allSelected;
          const checkboxes = document.querySelectorAll('.image-checkbox-input');
          
          if (allSelected) {
            checkboxes.forEach(checkbox => {
              checkbox.checked = true;
              selectedImages.add(checkbox.dataset.imageId);
            });
            selectAllBtn.innerHTML = '<i class="fas fa-times-circle"></i> Deselect All';
          } else {
            checkboxes.forEach(checkbox => {
              checkbox.checked = false;
            });
            selectedImages.clear();
            selectAllBtn.innerHTML = '<i class="fas fa-check-square"></i> Select All';
          }
          
          updateSelectionUI();
        });

        // Bulk delete button
        bulkDeleteBtn.addEventListener('click', function() {
          if (selectedImages.size === 0) return;
          
          const modal = document.getElementById('delete-modal');
          const confirmBtn = document.getElementById('confirm-delete-btn');
          const filenameElement = document.getElementById('delete-filename');
          
          filenameElement.textContent = `${selectedImages.size} images selected`;
          modal.style.display = 'block';
          
          confirmBtn.onclick = function() {
            bulkDeleteImages(Array.from(selectedImages));
            modal.style.display = 'none';
          };
        });

        function updateSelectionUI() {
          selectedCountSpan.textContent = `${selectedImages.size} selected`;
          bulkDeleteBtn.disabled = selectedImages.size === 0;
        }

        function bulkDeleteImages(imageIds) {
          const modal = document.getElementById('upload-modal');
          const statusDiv = document.getElementById('upload-status');
          const progressFill = document.getElementById('upload-progress-fill');
          const progressPercentage = document.getElementById('upload-percentage');
          
          modal.style.display = 'block';
          statusDiv.textContent = `Deleting ${imageIds.length} image(s)...`;
          progressFill.style.width = '50%';
          progressPercentage.textContent = '50%';
          
          fetch('{% url "bulk_delete_images" %}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
              image_ids: imageIds
            })
          })
          .then(response => response.json())
          .then(data => {
            progressFill.style.width = '100%';
            progressPercentage.textContent = '100%';
            
            if (data.success) {
              showNotification(`Deleted ${data.deleted_count} images successfully`, 'success');
              
              // Remove deleted images from the UI
              data.deleted_filenames.forEach(filename => {
                const cards = document.querySelectorAll('.image-card');
                cards.forEach(card => {
                  const nameElement = card.querySelector('.image-name');
                  if (nameElement && nameElement.textContent.trim() === filename) {
                    card.remove();
                  }
                });
              });
              
              // Show info if images with usage were deleted
              if (data.deleted_with_usage_count > 0) {
                showNotification(`Note: ${data.deleted_with_usage_count} images that were in use have been deleted`, 'info');
              }
              
              // Show warnings for any errors
              if (data.delete_errors && data.delete_errors.length > 0) {
                showNotification(`${data.delete_errors.length} images had deletion errors`, 'error');
              }
            } else {
              showNotification(data.error || 'Bulk delete failed', 'error');
            }
            
            // Reset selection
            selectedImages.clear();
            updateSelectionUI();
            document.querySelectorAll('.image-checkbox-input').forEach(cb => cb.checked = false);
            allSelected = false;
            selectAllBtn.innerHTML = '<i class="fas fa-check-square"></i> Select All';
            
            setTimeout(() => {
              modal.style.display = 'none';
            }, 1500);
          })
          .catch(error => {
            showNotification('Bulk delete failed: ' + error.message, 'error');
            modal.style.display = 'none';
          });
        }
        function setupFileUpload() {
          const uploadArea = document.getElementById('upload-area');
          const fileInput = document.getElementById('file-input');
          const browseBtn = uploadArea.querySelector('.browse-link');

          browseBtn.addEventListener('click', () => {
            fileInput.click();
          });

          // Drag and drop
          uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
          });

          uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
          });

          uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
              handleFileUpload(files);
            }
          });

          fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
              handleFileUpload(e.target.files);
            }
          });
        }

        function handleFileUpload(files) {
          const formData = new FormData();
          
          for (let file of files) {
            formData.append('images', file);
          }

          const modal = document.getElementById('upload-modal');
          const statusDiv = document.getElementById('upload-status');
          const progressFill = document.getElementById('upload-progress-fill');
          const progressPercentage = document.getElementById('upload-percentage');
          
          modal.style.display = 'block';
          statusDiv.textContent = `Uploading ${files.length} file(s)...`;
          
          let progress = 0;
          const progressInterval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            
            progressFill.style.width = progress + '%';
            progressPercentage.textContent = Math.round(progress) + '%';
          }, 200);

          fetch('{% url "upload_images" %}', {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRFToken': getCookie('csrftoken')
            }
          })
          .then(response => response.json())
          .then(data => {
            clearInterval(progressInterval);
            progressFill.style.width = '100%';
            progressPercentage.textContent = '100%';
            statusDiv.textContent = 'Upload complete!';
            
            setTimeout(() => {
              modal.style.display = 'none';
              if (data.success) {
                showNotification(`${data.uploaded} images uploaded successfully!`, 'success');
                if (data.errors && data.errors.length > 0) {
                  showNotification(`${data.failed} files failed to upload`, 'warning');
                }
                setTimeout(() => window.location.reload(), 1500);
              } else {
                showNotification(data.error || 'Upload failed', 'error');
              }
            }, 500);
          })
          .catch(error => {
            clearInterval(progressInterval);
            modal.style.display = 'none';
            showNotification('Upload failed: ' + error.message, 'error');
          });
        }

        function loadImageUsage() {
          const imageCards = document.querySelectorAll('.image-card');
          
          imageCards.forEach((card, index) => {
            const imageId = card.dataset.imageId;
            const usageElement = card.querySelector(`#usage-${imageId}`);
            
            // Add a small delay between requests to avoid overwhelming the server
            setTimeout(() => {
              fetch(`{% url 'get_image_usage_summary' 0 %}`.replace('0', imageId))
                .then(response => {
                  if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                  }
                  return response.json();
                })
                .then(data => {
                  if (data.total_usage > 0) {
                    // Create usage display with detailed breakdown
                    let usageHtml = `<i class="fas fa-check-circle" style="color: #10b981;"></i> Used in ${data.total_usage} question(s)`;
                    
                    // Add detailed breakdown with enhanced Model Paper support
                    let tagParts = [];
                    if (data.questionbank_count > 0) {
                      tagParts.push(`QB(${data.questionbank_count})`);
                    }
                    if (data.modelpaper_available && data.modelpaper_count > 0) {
                      tagParts.push(`MP(${data.modelpaper_count})`);
                    }
                    
                    if (tagParts.length > 0) {
                      usageHtml += ` <span class="usage-tags">${tagParts.join(', ')}</span>`;
                    }
                    
                    usageElement.innerHTML = usageHtml;
                    usageElement.style.background = '#ecfdf5';
                    usageElement.style.color = '#065f46';
                    usageElement.style.border = '1px solid #10b981';
                    
                    // Update card styling to indicate usage
                    card.style.borderLeft = '4px solid #10b981';
                  } else {
                    usageElement.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i> Not used`;
                    usageElement.style.background = '#fffbeb';
                    usageElement.style.color = '#92400e';
                    usageElement.style.border = '1px solid #f59e0b';
                    
                    // Update card styling to indicate no usage
                    card.style.borderLeft = '4px solid #f59e0b';
                  }
                })
                .catch(error => {
                  console.error('Error loading usage for image', imageId, ':', error);
                  usageElement.innerHTML = `<i class="fas fa-question-circle" style="color: #6b7280;"></i> Error loading`;
                  usageElement.style.background = '#f3f4f6';
                  usageElement.style.color = '#6b7280';
                });
            }, index * 100); // Stagger requests by 100ms
          });
        }

        // Global functions
        window.viewImageUsage = function(imageId) {
          const modal = document.getElementById('usage-modal');
          const content = document.getElementById('usage-content');
          
          content.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading usage details...</div>';
          modal.style.display = 'block';
          
          fetch(`{% url 'get_image_usage' 0 %}`.replace('0', imageId))
            .then(response => response.json())
            .then(data => {
              let usageHtml = `
                <div class="usage-details">
                  <h4>${data.filename}</h4>
                  <div class="usage-summary">
                    <p><strong>Total Usage: ${data.usage_count} question(s)</strong></p>
                    ${data.questionbank_count > 0 ? `<p><i class="fas fa-question-circle" style="color: #3b82f6;"></i> QuestionBank: ${data.questionbank_count} questions</p>` : ''}
                    ${data.modelpaper_available && data.modelpaper_count > 0 ? `<p><i class="fas fa-file-alt" style="color: #10b981;"></i> Model Papers: ${data.modelpaper_count} questions</p>` : ''}
                  </div>
              `;
              
              if (data.questions && data.questions.length > 0) {
                usageHtml += '<div class="questions-list">';
                data.questions.forEach(q => {
                  usageHtml += `
                    <div class="question-item">
                      <div class="question-header">
                        <span class="source-tag ${q.source_tag}">${q.source_tag}</span>
                        <span class="usage-type-badge">${q.usage_type}</span>
                      </div>
                      <div class="question-preview">${q.question_preview}</div>
                      <div class="question-meta">
                        <span class="badge">${q.degree || 'N/A'}</span>
                        <span class="badge">${q.year || 'N/A'}</span>
                        <span class="badge">${q.subject || 'N/A'}</span>
                        <span class="badge">${q.topic || 'N/A'}</span>
                        ${q.paper_name ? `<span class="badge paper-name">${q.paper_name}</span>` : ''}
                      </div>
                      <div class="question-actions">
                        <a href="${q.edit_url}" class="btn-edit" target="_blank">
                          <i class="fas fa-edit"></i> Edit
                        </a>
                      </div>
                    </div>
                  `;
                });
                usageHtml += '</div>';
              } else {
                usageHtml += '<p class="no-usage">This image is not currently used in any questions.</p>';
              }
              
              usageHtml += '</div>';
              content.innerHTML = usageHtml;
            })
            .catch(error => {
              console.error('Error loading usage:', error);
              content.innerHTML = `<div class="error-state">Error loading usage details: ${error.message}</div>`;
            });
        };

        window.deleteImage = function(imageId, filename) {
          const modal = document.getElementById('delete-modal');
          const filenameElement = document.getElementById('delete-filename');
          const confirmBtn = document.getElementById('confirm-delete-btn');
          
          filenameElement.textContent = filename;
          modal.style.display = 'block';
          
          confirmBtn.onclick = function() {
            fetch(`{% url 'delete_image' 0 %}`.replace('0', imageId), {
              method: 'POST',
              headers: {
                'X-CSRFToken': getCookie('csrftoken')
              }
            })
            .then(response => response.json())
            .then(data => {
              modal.style.display = 'none';
              if (data.success) {
                showNotification(data.message, 'success');
                // Remove the image card from the grid
                const imageCard = document.querySelector(`[data-image-id="${imageId}"]`);
                if (imageCard) {
                  imageCard.remove();
                }
              } else {
                showNotification(data.error, 'error');
              }
            })
            .catch(error => {
              modal.style.display = 'none';
              showNotification('Delete failed: ' + error.message, 'error');
            });
          };
        };

        // View toggle functionality
        document.querySelectorAll('.view-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const view = this.dataset.view;
            const grid = document.getElementById('images-grid');
            
            if (view === 'list') {
              grid.classList.add('list-view');
            } else {
              grid.classList.remove('list-view');
            }
          });
        });

        // Close modals
        document.querySelectorAll('.close-modal').forEach(btn => {
          btn.addEventListener('click', function() {
            this.closest('.modal').style.display = 'none';
          });
        });

        window.addEventListener('click', function(e) {
          if (e.target.classList.contains('modal')) {
            e.target.style.display = 'none';
          }
        });

        function showNotification(message, type = 'info') {
          const notification = document.createElement('div');
          notification.className = `notification ${type}`;
          notification.innerHTML = `
            <i class="fas fa-${type === 'error' ? 'times-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
            <span>${message}</span>
            <button class="close-notification">&times;</button>
          `;
          
          document.body.appendChild(notification);
          
          setTimeout(() => {
            notification.classList.add('show');
          }, 100);
          
          setTimeout(() => {
            notification.remove();
          }, 5000);
          
          notification.querySelector('.close-notification').addEventListener('click', () => {
            notification.remove();
          });
        }

        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }
      });
    </script>

    <style>
      /* Enhanced styles for improved usage display and Model Paper support */
      .usage-tags {
        margin-left: 0.5rem;
        font-size: 0.7rem;
        font-weight: bold;
      }
      
      .usage-summary {
        background: #f8fafc;
        padding: 1rem;
        border-radius: 6px;
        margin: 1rem 0;
        border-left: 4px solid #3b82f6;
      }
      
      .usage-summary p {
        margin: 0.5rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .question-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      }
      
      .source-tag {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: bold;
        color: white;
      }
      
      .source-tag.QB {
        background: #3b82f6;
      }
      
      .source-tag.MP {
        background: #10b981;
      }
      
      .usage-type-badge {
        padding: 0.2rem 0.4rem;
        background: #f3f4f6;
        color: #374151;
        border-radius: 3px;
        font-size: 0.65rem;
        font-weight: 500;
      }
      
      .question-actions {
        margin-top: 0.5rem;
      }
      
      .btn-edit {
        padding: 0.25rem 0.5rem;
        background: #f59e0b;
        color: white;
        text-decoration: none;
        border-radius: 3px;
        font-size: 0.75rem;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
      }
      
      .btn-edit:hover {
        background: #d97706;
        color: white;
      }
      
      .paper-name {
        background: #10b981 !important;
        color: white !important;
      }

      /* Image Management Specific Styles */
      .image-management-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .stats-section {
        margin-bottom: 2rem;
      }

      .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }

      .stat-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        border: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .stat-card.success {
        border-left: 4px solid #10b981;
      }

      .stat-card.warning {
        border-left: 4px solid #f59e0b;
      }

      .stat-icon {
        background: #f3f4f6;
        padding: 1rem;
        border-radius: 50%;
        color: #6b7280;
      }

      .stat-content h3 {
        font-size: 1.875rem;
        font-weight: bold;
        color: #111827;
        margin: 0;
      }

      .stat-content p {
        color: #6b7280;
        margin: 0;
      }

      .stat-content small {
        color: #9ca3af;
        font-size: 0.75rem;
        display: block;
        margin-top: 0.25rem;
      }

      .upload-section {
        margin-bottom: 2rem;
      }

      .upload-area {
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        background: #f9fafb;
        transition: border-color 0.2s;
      }

      .upload-area:hover,
      .upload-area.drag-over {
        border-color: #3b82f6;
        background: #eff6ff;
      }

      .upload-icon {
        font-size: 3rem;
        color: #9ca3af;
        margin-bottom: 1rem;
      }

      .browse-link {
        color: #3b82f6;
        background: none;
        border: none;
        text-decoration: underline;
        cursor: pointer;
      }

      .file-requirements {
        margin-top: 1rem;
        text-align: left;
        background: white;
        padding: 1rem;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
      }

      .file-requirements h4 {
        margin: 0 0 0.5rem 0;
        color: #374151;
        font-size: 0.875rem;
      }

      .file-requirements ul {
        margin: 0;
        padding-left: 1.25rem;
        font-size: 0.75rem;
        color: #6b7280;
      }

      .controls-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .search-controls {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .filter-select {
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background: white;
        color: #374151;
        font-size: 0.875rem;
      }

      .btn-clear {
        padding: 0.75rem 1rem;
        background: #6b7280;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-clear:hover {
        background: #4b5563;
        color: white;
      }

      .view-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .results-count {
        color: #6b7280;
        font-size: 0.875rem;
      }

      .view-options {
        display: flex;
        gap: 0.25rem;
      }

      .view-btn {
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        background: white;
        color: #6b7280;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .view-btn:hover,
      .view-btn.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
      }

      .images-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1.5rem;
      }

      .images-grid.list-view {
        grid-template-columns: 1fr;
      }

      .images-grid.list-view .image-card {
        display: flex;
        align-items: center;
      }

      .images-grid.list-view .image-preview {
        width: 100px;
        height: 100px;
        flex-shrink: 0;
      }

      .images-grid.list-view .image-info {
        flex: 1;
        padding: 1rem;
      }

      .image-card {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #e5e7eb;
        border-left: 4px solid #e5e7eb;
        transition: transform 0.2s, box-shadow 0.2s, border-left-color 0.3s;
        position: relative; /* Added for checkbox positioning */
      }

      .image-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      /* Checkbox styling */
      .image-checkbox {
        position: absolute;
        top: 0.5rem;
        left: 0.5rem;
        z-index: 10;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 4px;
        padding: 0.25rem;
        backdrop-filter: blur(4px);
      }

      .image-checkbox-input {
        width: 1.2rem;
        height: 1.2rem;
        cursor: pointer;
        accent-color: #3b82f6;
      }

      .image-preview {
        position: relative;
        height: 200px;
        overflow: hidden;
        background: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .image-preview img {
        max-width: 100%;
        max-height: 100%;
        object-fit: cover;
      }

      .image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .image-preview:hover .image-overlay {
        opacity: 1;
      }

      .image-overlay .btn-icon {
        background: white;
        color: #374151;
        border: none;
        padding: 0.75rem;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s;
      }

      .image-overlay .btn-icon:hover {
        background: #f3f4f6;
      }

      .image-overlay .delete-btn:hover {
        background: #fef2f2;
        color: #dc2626;
      }

      .image-info {
        padding: 1rem;
      }

      .image-name {
        font-weight: 500;
        color: #111827;
        margin-bottom: 0.5rem;
        word-break: break-word;
      }

      .image-meta {
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: #6b7280;
        margin-bottom: 0.5rem;
      }

      .image-usage {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        background: #f3f4f6;
        border-radius: 4px;
        text-align: center;
        border: 1px solid transparent;
        transition: all 0.3s;
      }

      /* Bulk actions styles */
      .bulk-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: #f8fafc;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
      }

      #selected-count {
        font-size: 0.875rem;
        color: #6b7280;
        margin-left: auto;
      }

      .no-images {
        text-align: center;
        padding: 4rem 2rem;
        color: #6b7280;
      }

      .no-images-content i {
        font-size: 4rem;
        color: #d1d5db;
        margin-bottom: 1rem;
      }

      .no-images-content h3 {
        color: #374151;
        margin-bottom: 0.5rem;
      }

      .pagination-container {
        margin-top: 2rem;
        display: flex;
        justify-content: center;
      }

      .pagination {
        display: flex;
        gap: 0.25rem;
      }

      .page-link {
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        color: #374151;
        text-decoration: none;
        border-radius: 4px;
        transition: all 0.2s;
      }

      .page-link:hover,
      .page-link.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
      }

      /* Modal Styles */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal-content {
        background: white;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-content.large {
        max-width: 800px;
      }

      .modal-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h3 {
        margin: 0;
        color: #111827;
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #6b7280;
        cursor: pointer;
      }

      .modal-body {
        padding: 1.5rem;
      }

      .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
      }

      .progress-bar {
        background: #f3f4f6;
        border-radius: 4px;
        height: 8px;
        overflow: hidden;
        margin-bottom: 1rem;
      }

      .progress-fill {
        background: #3b82f6;
        height: 100%;
        transition: width 0.3s;
      }

      .progress-info {
        display: flex;
        justify-content: space-between;
        font-size: 0.875rem;
        color: #6b7280;
      }

      .usage-details h4 {
        margin: 0 0 1rem 0;
        color: #111827;
      }

      .questions-list {
        max-height: 300px;
        overflow-y: auto;
      }

      .question-item {
        padding: 0.75rem;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        margin-bottom: 0.5rem;
      }

      .question-preview {
        font-size: 0.875rem;
        color: #374151;
        margin-bottom: 0.5rem;
      }

      .question-meta {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .badge {
        background: #f3f4f6;
        color: #6b7280;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
      }

      .warning-text {
        color: #dc2626;
        font-size: 0.875rem;
      }

      .loading {
        text-align: center;
        color: #6b7280;
        padding: 2rem;
      }

      .error-state {
        text-align: center;
        color: #dc2626;
        padding: 1rem;
      }

      .no-usage {
        text-align: center;
        color: #6b7280;
        padding: 2rem;
        font-style: italic;
      }

      /* Notification styles */
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border-radius: 8px;
        padding: 1rem 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #3b82f6;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        z-index: 1001;
        transform: translateX(100%);
        transition: transform 0.3s;
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success {
        border-left-color: #10b981;
      }

      .notification.error {
        border-left-color: #dc2626;
      }

      .notification.warning {
        border-left-color: #f59e0b;
      }

      .close-notification {
        background: none;
        border: none;
        color: #6b7280;
        cursor: pointer;
        margin-left: auto;
      }

      /* Image error display */
      .image-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #dc2626;
        font-size: 0.875rem;
        text-align: center;
        background: #fef2f2;
      }

      .image-error i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
      }

      .image-error small {
        color: #6b7280;
        font-size: 0.75rem;
        margin-top: 0.25rem;
      }

      /* Breadcrumb styles */
      .breadcrumb-nav {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        padding: 0.75rem 1rem;
        background: #f9fafb;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
      }

      .breadcrumb-link {
        color: #3b82f6;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
      }

      .breadcrumb-link:hover {
        text-decoration: underline;
      }

      .breadcrumb-current {
        color: #6b7280;
        font-size: 0.875rem;
      }

      /* Messages styles */
      .messages {
        margin-bottom: 1.5rem;
      }

      .message {
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .message.success {
        background: #ecfdf5;
        color: #065f46;
        border: 1px solid #d1fae5;
      }

      .message.error {
        background: #fef2f2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }

      .message.warning {
        background: #fffbeb;
        color: #92400e;
        border: 1px solid #fed7aa;
      }

      .message.info {
        background: #eff6ff;
        color: #1e40af;
        border: 1px solid #dbeafe;
      }

      /* Section description styles */
      .section-description {
        color: #6b7280;
        margin-bottom: 1rem;
        font-size: 0.875rem;
      }

      /* Search container styles */
      .search-container {
        position: relative;
        display: flex;
        align-items: center;
      }

      .search-input {
        padding: 0.75rem 2.5rem 0.75rem 1rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        width: 300px;
        font-size: 0.875rem;
      }

      .search-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .search-icon {
        position: absolute;
        right: 0.75rem;
        color: #9ca3af;
      }

      /* Button styles */
      .btn-secondary {
        background: #6b7280;
        color: white;
        border: none;
        padding: 0.75rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: background 0.2s;
      }

      .btn-secondary:hover {
        background: #4b5563;
      }

      .btn-secondary:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        opacity: 0.6;
      }

      .btn-danger {
        background: #dc2626;
        color: white;
        border: none;
        padding: 0.75rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.875rem;
        transition: background 0.2s;
      }

      .btn-danger:hover {
        background: #b91c1c;
      }

      .btn-danger:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        opacity: 0.6;
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .image-management-container {
          padding: 1rem;
        }

        .stats-cards {
          grid-template-columns: 1fr;
        }

        .controls-section {
          flex-direction: column;
          align-items: stretch;
        }

        .search-controls {
          flex-direction: column;
          gap: 0.5rem;
        }

        .search-input {
          width: 100%;
        }

        .images-grid {
          grid-template-columns: 1fr;
        }

        .modal-content {
          width: 95%;
          margin: 1rem;
        }

        .upload-area {
          padding: 1.5rem;
        }

        .breadcrumb-nav {
          flex-wrap: wrap;
        }

        .bulk-actions {
          flex-wrap: wrap;
          gap: 0.5rem;
        }

        .image-checkbox {
          top: 0.25rem;
          left: 0.25rem;
        }

        .image-checkbox-input {
          width: 1rem;
          height: 1rem;
        }
      }
    </style>
  </body>
</html>