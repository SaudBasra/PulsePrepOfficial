{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    {% include 'includes/favicon.html' %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PulsePrep - {% if is_edit %}Edit{% else %}Create{% endif %} Mock Test</title>
    <link rel="stylesheet" href="{% static 'css/DAstyles.css' %}" />
    <link rel="stylesheet" href="{% static 'css/mockTest.css' %}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
      .question-selection-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }
      
      .question-pool, .selected-questions {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        height: 500px;
        overflow-y: auto;
      }
      
      .question-item {
        padding: 10px;
        margin: 5px 0;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .question-item:hover {
        background-color: #f5f5f5;
      }
      
      .question-item.selected {
        background-color: #e3f2fd;
        border-color: #2196f3;
      }
      
      .question-item input[type="checkbox"] {
        margin-right: 10px;
      }
      
      .question-meta {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }
      
      .difficulty-easy { color: #4caf50; }
      .difficulty-medium { color: #ff9800; }
      .difficulty-hard { color: #f44336; }
      
      .selection-stats {
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 4px;
        margin-bottom: 10px;
        text-align: center;
      }
      
      .filter-section {
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      
      .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-bottom: 10px;
      }
      
      .pagination-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        padding: 15px;
        border-top: 1px solid #e0e0e0;
        margin-top: 10px;
      }
      
      .pagination-controls button {
        padding: 5px 10px;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
        border-radius: 4px;
      }
      
      .pagination-controls button:hover:not(:disabled) {
        background-color: #f5f5f5;
      }
      
      .pagination-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .pagination-controls .current-page {
        background-color: #2196f3;
        color: white;
      }
      
      .question-pool-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }
      
      .questions-count {
        font-size: 14px;
        color: #666;
      }
      
      .availability-warning {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        display: none;
      }
      
      .availability-warning.show {
        display: block;
      }
      
      .warning-content {
        display: flex;
        align-items: flex-start;
        gap: 10px;
      }
      
      .warning-icon {
        color: #f39c12;
        font-size: 20px;
        margin-top: 2px;
      }
      
      .warning-text {
        flex: 1;
      }
      
      .warning-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      
      .hidden { display: none; }
    </style>
  </head>
  <body>
    <div class="container">
      
<!-- Sidebar Navigation -->
<aside class="sidebar">
  <div class="logo-container">
    <img src="{% static 'images/Logo.png' %}" alt="PulsePrep Logo" class="logo" />
  </div>
  <nav class="nav-menu">
    <a href="{% url 'dashboard' %}" class="nav-item {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
      <i class="fas fa-th-large"></i>
      <span>Dashboard</span>
    </a>
    <a href="{% url 'questionbank' %}" class="nav-item {% if request.resolver_match.url_name == 'questionbank' %}active{% endif %}">
      <i class="fas fa-question-circle"></i>
      <span>Manage Questions</span>
    </a>
    <a href="{% url 'manage_csv' %}" class="nav-item {% if request.resolver_match.url_name == 'manage_csv' %}active{% endif %}">
      <i class="fas fa-file-csv"></i>
      <span>Manage CSVs</span>
    </a>
    <a href="{% url 'managemodule' %}" class="nav-item {% if request.resolver_match.url_name == 'managemodule' %}active{% endif %}">
      <i class="fas fa-cubes"></i>
      <span>Modules</span>
    </a>
    <a href="/admin/user_management/customuser/" class="nav-item">
      <i class="fas fa-users"></i>
      <span>Manage Users</span>
    </a>
    <a href="{% url 'mocktest_list' %}" class="nav-item {% if request.resolver_match.url_name == 'mocktest_list' %}active{% endif %}">
      <i class="fas fa-vial"></i>
      <span>Mock Tests</span>
    </a>
    <a href="{% url 'analytics_report' %}" class="nav-item {% if request.resolver_match.url_name == 'analytics_report' %}active{% endif %}">
      <i class="fas fa-chart-bar"></i>
      <span>Analytics & Reports</span>
    </a>
    <a href="{% url 'myaccount' %}" class="nav-item {% if request.resolver_match.url_name == 'myaccount' %}active{% endif %}">
      <i class="fas fa-user"></i>
      <span>My Account</span>
    </a>
    <a href="{% url 'notification_center' %}" class="nav-item {% if request.resolver_match.url_name == 'notification_center' %}active{% endif %}">
      <i class="fas fa-bell"></i>
      <span>Notifications</span>
      <span class="notification-badge-sidebar"></span>
    </a>
    <a href="{% url 'logout' %}" class="nav-item">
      <i class="fas fa-sign-out-alt"></i>
      <span>Logout</span>
    </a>
  </nav>
</aside>

      <!-- Main Content -->
      <main class="main-content">
        <header class="header">
          <div class="mobile-menu">
            <button id="sidebar-toggle">
              <i class="fas fa-bars"></i>
            </button>
          </div>
          <h1>{% if is_edit %}Edit{% else %}Create{% endif %} Mock Test</h1>
          <div class="user-menu">
            <a href="{% url 'notification_center' %}"><i class="fas fa-bell"></i></a>
            <div class="avatar">
              <img src="https://i.pravatar.cc/40?img=12" alt="User Avatar" />
            </div>
          </div>
        </header>

        <!-- Form Content -->
        <div class="dashboard-content">
          <section class="test-form-section">
            <form method="POST" id="mock-test-form">
              {% csrf_token %}
              
              <div class="form-grid">
                <!-- Basic Information -->
                <div class="form-section">
                  <h3 class="form-section-title">Basic Information</h3>
                  
                  <div class="form-group">
                    <label for="id_title">Title of Test <span class="required">*</span></label>
                    {{ form.title }}
                  </div>
                  
                  <div class="form-group">
                    <label for="id_description">Description</label>
                    {{ form.description }}
                  </div>
                  
                  <div class="form-row">
                    <div class="form-group">
                      <label for="id_start_datetime">Start Date & Time <span class="required">*</span></label>
                      {{ form.start_datetime }}
                    </div>
                    
                    <div class="form-group">
                      <label for="id_end_datetime">End Date & Time <span class="required">*</span></label>
                      {{ form.end_datetime }}
                    </div>
                  </div>
                  
                  <div class="form-row">
                    <div class="form-group">
                      <label for="id_duration_minutes">Duration (minutes) <span class="required">*</span></label>
                      {{ form.duration_minutes }}
                    </div>
                    
                    <div class="form-group">
                      <label for="id_max_attempts">Max Attempts</label>
                      {{ form.max_attempts }}
                    </div>
                  </div>
                  
                  <div class="form-row">
                    <div class="form-group">
                      <label for="id_passing_percentage">Passing Percentage</label>
                      {{ form.passing_percentage }}
                    </div>
                    
                    <div class="form-group">
                      <label for="id_status">Status</label>
                      {{ form.status }}
                    </div>
                  </div>
                </div>
                
                <!-- Test Classification -->
                <div class="form-section">
                  <h3 class="form-section-title">Test Classification</h3>
                  
                  <div class="form-group">
                    <label for="id_degree">Degree</label>
                    {{ form.degree }}
                  </div>
                  
                  <div class="form-group">
                    <label for="id_year">Year</label>
                    {{ form.year }}
                  </div>
                  
                  <div class="form-group">
                    <label for="id_block">Block</label>
                    <select id="id_block" name="block" class="form-control">
                      <option value="">Select Block</option>
                      {% for block in blocks %}
                        <option value="{{ block.block }}" {% if form.block.value == block.block %}selected{% endif %}>{{ block.block }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="id_module">Module</label>
                    <select id="id_module" name="module" class="form-control">
                      <option value="">Select Module</option>
                      {% for module in modules %}
                        <option value="{{ module.module }}" {% if form.module.value == module.module %}selected{% endif %}>{{ module.module }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="id_subject">Subject</label>
                    <select id="id_subject" name="subject" class="form-control">
                      <option value="">Select Subject</option>
                      {% for subject in subjects %}
                        <option value="{{ subject.subject }}" {% if form.subject.value == subject.subject %}selected{% endif %}>{{ subject.subject }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="id_topic">Topic</label>
                    <select id="id_topic" name="topic" class="form-control">
                      <option value="">Select Topic</option>
                      {% for topic in topics %}
                        <option value="{{ topic.topic }}" {% if form.topic.value == topic.topic %}selected{% endif %}>{{ topic.topic }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                
                <!-- Question Configuration -->
                <div class="form-section">
                  <h3 class="form-section-title">Question Configuration</h3>
                  
                  <div class="form-group">
                    <label for="id_total_questions">Total Questions <span class="required">*</span></label>
                    {{ form.total_questions }}
                  </div>
                  
                  <div class="form-group">
                    <label>Question Selection Type <span class="required">*</span></label>
                    <div class="radio-group">
                      {% for radio in form.selection_type %}
                        <label class="radio-label">
                          {{ radio.tag }}
                          <span>{{ radio.choice_label }}</span>
                        </label>
                      {% endfor %}
                    </div>
                  </div>
                  
                  <!-- Availability Warning for Random Selection -->
                  <div id="availability-warning" class="availability-warning">
                    <div class="warning-content">
                      <i class="fas fa-exclamation-triangle warning-icon"></i>
                      <div class="warning-text">
                        <strong>Insufficient Questions Available</strong>
                        <p id="warning-message"></p>
                        <div class="warning-actions">
                          <button type="button" id="proceed-with-available" class="action-button">
                            Proceed with Available Questions
                          </button>
                          <button type="button" id="adjust-criteria" class="action-button secondary">
                            Adjust Criteria
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Random Selection Options -->
                  <div id="random-options" class="{% if form.selection_type.value != 'random' %}hidden{% endif %}">
                    <div class="form-row">
                      <div class="form-group">
                        <label for="id_easy_percentage">Easy %</label>
                        {{ form.easy_percentage }}
                      </div>
                      
                      <div class="form-group">
                        <label for="id_medium_percentage">Medium %</label>
                        {{ form.medium_percentage }}
                      </div>
                      
                      <div class="form-group">
                        <label for="id_hard_percentage">Hard %</label>
                        {{ form.hard_percentage }}
                      </div>
                    </div>
                    <small class="text-muted">Note: Percentages must sum to 100%</small>
                    <div id="availability-info" class="selection-stats">
                      <span id="available-count">Checking availability...</span>
                    </div>
                  </div>
                  
                  <!-- Manual Selection Button -->
                  <div id="manual-options" class="{% if form.selection_type.value != 'manual' %}hidden{% endif %}">
                    <button type="button" class="action-button" id="select-questions-btn">
                      <i class="fas fa-list"></i> Select Questions
                    </button>
                    <div class="selection-stats">
                      <span id="selected-count">0</span> questions selected
                    </div>
                  </div>
                  
                  <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                      {{ form.randomize_questions }} <span>Randomize Questions</span>
                    </label>
                    <label class="checkbox-label">
                      {{ form.randomize_options }} <span>Randomize Options</span>
                    </label>
                    <label class="checkbox-label">
                      {{ form.show_explanations }} <span>Show Explanations</span>
                    </label>
                  </div>
                </div>
              </div>
              
              <!-- Form Actions -->
              <div class="form-actions">
                <a href="{% url 'mocktest_list' %}" class="action-button secondary">Cancel</a>
                {% if test %}
                  <a href="{% url 'preview_test' test.id %}" class="action-button">Preview</a>
                {% endif %}
                <button type="submit" class="action-button primary">
                  {% if is_edit %}Update{% else %}Create{% endif %} Test
                </button>
              </div>
            </form>
          </section>
        </div>
      </main>
    </div>

    <!-- Manual Question Selection Modal -->
    <div id="question-selection-modal" class="modal hidden">
      <div class="modal-content" style="max-width: 90%; width: 1200px;">
        <div class="modal-header">
          <h3>Select Questions</h3>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <!-- Filters -->
          <div class="filter-section">
            <div class="filter-row">
              <select id="filter-degree" class="form-control">
                <option value="">All Degrees</option>
                <option value="MBBS">MBBS</option>
                <option value="BDS">BDS</option>
              </select>
              
              <select id="filter-year" class="form-control">
                <option value="">All Years</option>
                <option value="1st">1st</option>
                <option value="2nd">2nd</option>
                <option value="3rd">3rd</option>
                <option value="4th">4th</option>
                <option value="5th">5th</option>
              </select>
              
              <select id="filter-block" class="form-control">
                <option value="">All Blocks</option>
              </select>
              
              <select id="filter-module" class="form-control">
                <option value="">All Modules</option>
              </select>
              
              <select id="filter-subject" class="form-control">
                <option value="">All Subjects</option>
              </select>
              
              <select id="filter-topic" class="form-control">
                <option value="">All Topics</option>
              </select>
              
              <button id="apply-filters" class="action-button primary">
                <i class="fas fa-filter"></i> Apply Filters
              </button>
              <button id="clear-filters" class="action-button secondary">
                <i class="fas fa-times"></i> Clear Filters
              </button>
            </div>
          </div>
          
          <!-- Question Selection -->
          <div class="question-selection-container">
            <div class="question-pool">
              <div class="question-pool-header">
                <h4>Available Questions</h4>
                <div class="questions-count">
                  Showing <span id="showing-count">0</span> of <span id="total-available">0</span> questions
                </div>
              </div>
              <div class="selection-stats">
                <button id="select-all-page" class="action-button">Select All (This Page)</button>
                <button id="clear-all-page" class="action-button">Clear All (This Page)</button>
              </div>
              <div id="available-questions"></div>
              <div class="pagination-controls">
                <button id="prev-page" disabled>Previous</button>
                <span id="page-info">Page 1 of 1</span>
                <button id="next-page" disabled>Next</button>
              </div>
            </div>
            
            <div class="selected-questions">
              <h4>Selected Questions (<span id="selected-total">0</span>)</h4>
              <div id="selected-questions-list"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="action-button secondary close-modal">Cancel</button>
          <button id="save-selection" class="action-button primary">Save Selection</button>
        </div>
      </div>
    </div>

    <script src="{% static 'js/DAscript.js' %}"></script>
    <script>
      let selectedQuestions = new Set();
      let currentPage = 1;
      let totalPages = 1;
      let totalQuestions = 0;
      let questionsPerPage = 100;
      let currentFilters = {};
      
      {% if test %}
        // If editing, load existing questions
        {% for tq in test.testquestion_set.all %}
          selectedQuestions.add({{ tq.question.id }});
        {% endfor %}
      {% endif %}
      
      // Update selected count
      document.getElementById('selected-count').textContent = selectedQuestions.size;
      
      // Selection type toggle
      document.querySelectorAll('input[name="selection_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.value === 'random') {
            document.getElementById('random-options').classList.remove('hidden');
            document.getElementById('manual-options').classList.add('hidden');
            checkAvailability();
          } else {
            document.getElementById('random-options').classList.add('hidden');
            document.getElementById('manual-options').classList.remove('hidden');
            document.getElementById('availability-warning').classList.remove('show');
          }
        });
      });
      
      // Check availability for random selection
      function checkAvailability() {
        const criteria = getCurrentCriteria();
        const totalRequested = parseInt(document.getElementById('id_total_questions').value) || 0;
        
        if (totalRequested === 0) return;
        
        fetch(`{% url 'check_question_availability' %}?${new URLSearchParams(criteria)}`)
          .then(response => response.json())
          .then(data => {
            const availableInfo = document.getElementById('available-count');
            availableInfo.innerHTML = `
              Available: <strong>${data.total_available}</strong> questions
              (Easy: ${data.easy}, Medium: ${data.medium}, Hard: ${data.hard})
            `;
            
            if (data.total_available < totalRequested) {
              showAvailabilityWarning(data, totalRequested);
            } else {
              document.getElementById('availability-warning').classList.remove('show');
            }
          })
          .catch(error => {
            console.error('Error checking availability:', error);
          });
      }
      
      function showAvailabilityWarning(data, requested) {
        const warning = document.getElementById('availability-warning');
        const message = document.getElementById('warning-message');
        
        message.innerHTML = `
          You requested <strong>${requested}</strong> questions, but only <strong>${data.total_available}</strong> are available with the current criteria.
          <br><br>
          Available breakdown:
          <ul>
            <li>Easy: ${data.easy} questions</li>
            <li>Medium: ${data.medium} questions</li>
            <li>Hard: ${data.hard} questions</li>
          </ul>
          Would you like to proceed with ${data.total_available} questions instead?
        `;
        
        warning.classList.add('show');
        
        document.getElementById('proceed-with-available').onclick = function() {
          document.getElementById('id_total_questions').value = data.total_available;
          warning.classList.remove('show');
        };
        
        document.getElementById('adjust-criteria').onclick = function() {
          warning.classList.remove('show');
        };
      }
      
      function getCurrentCriteria() {
        return {
          degree: document.getElementById('id_degree').value,
          year: document.getElementById('id_year').value,
          block: document.getElementById('id_block').value,
          module: document.getElementById('id_module').value,
          subject: document.getElementById('id_subject').value,
          topic: document.getElementById('id_topic').value,
          total_questions: document.getElementById('id_total_questions').value,
          easy_percentage: document.getElementById('id_easy_percentage').value,
          medium_percentage: document.getElementById('id_medium_percentage').value,
          hard_percentage: document.getElementById('id_hard_percentage').value,
        };
      }
      
      // Add event listeners for availability checking
      document.getElementById('id_total_questions').addEventListener('input', checkAvailability);
      document.getElementById('id_easy_percentage').addEventListener('input', checkAvailability);
      document.getElementById('id_medium_percentage').addEventListener('input', checkAvailability);
      document.getElementById('id_hard_percentage').addEventListener('input', checkAvailability);
      
      // Dynamic dropdowns
      const degreeSelect = document.getElementById('id_degree');
      const yearSelect = document.getElementById('id_year');
      const blockSelect = document.getElementById('id_block');
      const moduleSelect = document.getElementById('id_module');
      const subjectSelect = document.getElementById('id_subject');
      const topicSelect = document.getElementById('id_topic');
      
      function updateDropdowns(changedField) {
        const degree = degreeSelect.value;
        const year = yearSelect.value;
        const block = blockSelect.value;
        const module = moduleSelect.value;
        const subject = subjectSelect.value;
        
        // Update blocks
        if (changedField === 'degree' || changedField === 'year') {
          fetch(`{% url 'get_hierarchy_data' %}?field=blocks&degree=${degree}&year=${year}`)
            .then(response => response.json())
            .then(data => {
              blockSelect.innerHTML = '<option value="">Select Block</option>';
              data.data.forEach(item => {
                blockSelect.innerHTML += `<option value="${item}">${item}</option>`;
              });
            });
        }
        
        // Update modules
        if (changedField === 'block' || changedField === 'degree' || changedField === 'year') {
          fetch(`{% url 'get_hierarchy_data' %}?field=modules&degree=${degree}&year=${year}&block=${block}`)
            .then(response => response.json())
            .then(data => {
              moduleSelect.innerHTML = '<option value="">Select Module</option>';
              data.data.forEach(item => {
                moduleSelect.innerHTML += `<option value="${item}">${item}</option>`;
              });
            });
        }
        
        // Update subjects
        if (changedField === 'module' || changedField === 'block') {
          fetch(`{% url 'get_hierarchy_data' %}?field=subjects&degree=${degree}&year=${year}&block=${block}&module=${module}`)
            .then(response => response.json())
            .then(data => {
              subjectSelect.innerHTML = '<option value="">Select Subject</option>';
              data.data.forEach(item => {
                subjectSelect.innerHTML += `<option value="${item}">${item}</option>`;
              });
            });
        }
        
        // Update topics
        if (changedField === 'subject' || changedField === 'module') {
          fetch(`{% url 'get_hierarchy_data' %}?field=topics&degree=${degree}&year=${year}&block=${block}&module=${module}&subject=${subject}`)
            .then(response => response.json())
            .then(data => {
              topicSelect.innerHTML = '<option value="">Select Topic</option>';
              data.data.forEach(item => {
                topicSelect.innerHTML += `<option value="${item}">${item}</option>`;
              });
            });
        }
        
        // Check availability if random selection is active
        if (document.querySelector('input[name="selection_type"]:checked').value === 'random') {
          checkAvailability();
        }
      }
      
      degreeSelect.addEventListener('change', () => updateDropdowns('degree'));
      yearSelect.addEventListener('change', () => updateDropdowns('year'));
      blockSelect.addEventListener('change', () => updateDropdowns('block'));
      moduleSelect.addEventListener('change', () => updateDropdowns('module'));
      subjectSelect.addEventListener('change', () => updateDropdowns('subject'));
      
      // Manual question selection
      const modal = document.getElementById('question-selection-modal');
      const selectQuestionsBtn = document.getElementById('select-questions-btn');
      const closeModalBtns = document.querySelectorAll('.close-modal');
      
      selectQuestionsBtn.addEventListener('click', function() {
        modal.classList.remove('hidden');
        currentPage = 1;
        loadQuestions();
      });
      
      closeModalBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          modal.classList.add('hidden');
        });
      });
      
      // Load questions for manual selection with pagination
      function loadQuestions() {
        const filters = {
          degree: document.getElementById('filter-degree').value,
          year: document.getElementById('filter-year').value,
          block: document.getElementById('filter-block').value,
          module: document.getElementById('filter-module').value,
          subject: document.getElementById('filter-subject').value,
          topic: document.getElementById('filter-topic').value,
          page: currentPage,
          per_page: questionsPerPage
        };
        
        currentFilters = filters;
        
        const queryString = Object.entries(filters)
          .filter(([key, value]) => value)
          .map(([key, value]) => `${key}=${encodeURIComponent(value)}`)
          .join('&');
        
        fetch(`{% url 'get_filtered_questions' %}?${queryString}`)
          .then(response => response.json())
          .then(data => {
            const container = document.getElementById('available-questions');
            container.innerHTML = '';
            
            totalQuestions = data.total_count;
            totalPages = Math.ceil(totalQuestions / questionsPerPage);
            
            // Update counters
            document.getElementById('total-available').textContent = totalQuestions;
            document.getElementById('showing-count').textContent = data.questions.length;
            document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
            
            // Update pagination buttons
            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
            
            data.questions.forEach(question => {
              const isSelected = selectedQuestions.has(question.id);
              const div = document.createElement('div');
              div.className = `question-item ${isSelected ? 'selected' : ''}`;
              div.innerHTML = `
                <label>
                  <input type="checkbox" value="${question.id}" ${isSelected ? 'checked' : ''}>
                  <span>${question.text}</span>
                </label>
                <div class="question-meta">
                  <span class="difficulty-${question.difficulty.toLowerCase()}">${question.difficulty}</span> | 
                  ${question.module} | ${question.subject} | ${question.topic}
                </div>
              `;
              
              div.querySelector('input').addEventListener('change', function() {
                if (this.checked) {
                  selectedQuestions.add(question.id);
                  div.classList.add('selected');
                } else {
                  selectedQuestions.delete(question.id);
                  div.classList.remove('selected');
                }
                updateSelectedDisplay();
              });
              
              container.appendChild(div);
            });
            
            updateSelectedDisplay();
          })
          .catch(error => {
            console.error('Error loading questions:', error);
            document.getElementById('available-questions').innerHTML = 
              '<p>Error loading questions. Please try again.</p>';
          });
      }
      
      // Pagination controls
      document.getElementById('prev-page').addEventListener('click', function() {
        if (currentPage > 1) {
          currentPage--;
          loadQuestions();
        }
      });
      
      document.getElementById('next-page').addEventListener('click', function() {
        if (currentPage < totalPages) {
          currentPage++;
          loadQuestions();
        }
      });
      
      // Update selected questions display
      function updateSelectedDisplay() {
        document.getElementById('selected-total').textContent = selectedQuestions.size;
        document.getElementById('selected-count').textContent = selectedQuestions.size;
        
        // Update the total questions field
        if (document.querySelector('input[name="selection_type"]:checked').value === 'manual') {
          document.getElementById('id_total_questions').value = selectedQuestions.size;
        }
        
        // Update selected questions list
        const selectedList = document.getElementById('selected-questions-list');
        selectedList.innerHTML = '';
        
        if (selectedQuestions.size > 0) {
          const selectedArray = Array.from(selectedQuestions);
          selectedArray.forEach((questionId, index) => {
            const div = document.createElement('div');
            div.className = 'question-item';
            div.innerHTML = `
              <span>Question ID: ${questionId}</span>
              <button type="button" class="remove-selected" data-id="${questionId}">
                <i class="fas fa-times"></i>
              </button>
            `;
            
            div.querySelector('.remove-selected').addEventListener('click', function() {
              selectedQuestions.delete(parseInt(this.dataset.id));
              updateSelectedDisplay();
              // Update checkboxes on current page
              const checkbox = document.querySelector(`input[value="${this.dataset.id}"]`);
              if (checkbox) {
                checkbox.checked = false;
                checkbox.closest('.question-item').classList.remove('selected');
              }
            });
            
            selectedList.appendChild(div);
          });
        } else {
          selectedList.innerHTML = '<p class="text-muted">No questions selected</p>';
        }
      }
      
      // Select all / Clear all for current page
      document.getElementById('select-all-page').addEventListener('click', function() {
        document.querySelectorAll('#available-questions input[type="checkbox"]').forEach(cb => {
          cb.checked = true;
          selectedQuestions.add(parseInt(cb.value));
          cb.closest('.question-item').classList.add('selected');
        });
        updateSelectedDisplay();
      });
      
      document.getElementById('clear-all-page').addEventListener('click', function() {
        document.querySelectorAll('#available-questions input[type="checkbox"]').forEach(cb => {
          cb.checked = false;
          selectedQuestions.delete(parseInt(cb.value));
          cb.closest('.question-item').classList.remove('selected');
        });
        updateSelectedDisplay();
      });
      
      // Apply filters
      document.getElementById('apply-filters').addEventListener('click', function() {
        currentPage = 1;
        loadQuestions();
      });
      
      // Clear filters
      document.getElementById('clear-filters').addEventListener('click', function() {
        document.getElementById('filter-degree').value = '';
        document.getElementById('filter-year').value = '';
        document.getElementById('filter-block').value = '';
        document.getElementById('filter-module').value = '';
        document.getElementById('filter-subject').value = '';
        document.getElementById('filter-topic').value = '';
        currentPage = 1;
        loadQuestions();
      });
      
      // Save selection
      document.getElementById('save-selection').addEventListener('click', function() {
        if (selectedQuestions.size === 0) {
          alert('Please select at least one question.');
          return;
        }
        
        // Update form field
        document.getElementById('id_total_questions').value = selectedQuestions.size;
        
        // Store selected questions (we'll submit them with the form)
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'selected_questions';
        input.value = JSON.stringify(Array.from(selectedQuestions));
        document.getElementById('mock-test-form').appendChild(input);
        
        modal.classList.add('hidden');
        alert(`${selectedQuestions.size} questions selected`);
      });
      
      // Form submission
      document.getElementById('mock-test-form').addEventListener('submit', function(e) {
        const selectionType = document.querySelector('input[name="selection_type"]:checked').value;
        
        if (selectionType === 'manual' && selectedQuestions.size === 0) {
          e.preventDefault();
          alert('Please select questions for the test.');
          return;
        }
        
        // Add selected questions to form if manual selection
        if (selectionType === 'manual') {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'selected_questions';
          input.value = JSON.stringify(Array.from(selectedQuestions));
          this.appendChild(input);
        }
      });
      
      // Initialize filter dropdowns
      function initializeFilterDropdowns() {
        // Copy main form values to filter dropdowns
        document.getElementById('filter-degree').value = degreeSelect.value;
        document.getElementById('filter-year').value = yearSelect.value;
        
        // Load hierarchy data for filters
        fetch(`{% url 'get_hierarchy_data' %}?field=blocks`)
          .then(response => response.json())
          .then(data => {
            const filterBlock = document.getElementById('filter-block');
            filterBlock.innerHTML = '<option value="">All Blocks</option>';
            data.data.forEach(item => {
              filterBlock.innerHTML += `<option value="${item}">${item}</option>`;
            });
          });
        
        fetch(`{% url 'get_hierarchy_data' %}?field=modules`)
          .then(response => response.json())
          .then(data => {
            const filterModule = document.getElementById('filter-module');
            filterModule.innerHTML = '<option value="">All Modules</option>';
            data.data.forEach(item => {
              filterModule.innerHTML += `<option value="${item}">${item}</option>`;
            });
          });
        
        fetch(`{% url 'get_hierarchy_data' %}?field=subjects`)
          .then(response => response.json())
          .then(data => {
            const filterSubject = document.getElementById('filter-subject');
            filterSubject.innerHTML = '<option value="">All Subjects</option>';
            data.data.forEach(item => {
              filterSubject.innerHTML += `<option value="${item}">${item}</option>`;
            });
          });
        
        fetch(`{% url 'get_hierarchy_data' %}?field=topics`)
          .then(response => response.json())
          .then(data => {
            const filterTopic = document.getElementById('filter-topic');
            filterTopic.innerHTML = '<option value="">All Topics</option>';
            data.data.forEach(item => {
              filterTopic.innerHTML += `<option value="${item}">${item}</option>`;
            });
          });
      }
      
      selectQuestionsBtn.addEventListener('click', initializeFilterDropdowns);
      
      // Initialize availability check on page load
      if (document.querySelector('input[name="selection_type"]:checked').value === 'random') {
        checkAvailability();
      }
    </script>

    <style>
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      
      .modal.hidden {
        display: none;
      }
      
      .modal-content {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        max-height: 90vh;
        overflow-y: auto;
      }
      
      .modal-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .modal-body {
        padding: 20px;
      }
      
      .modal-footer {
        padding: 20px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }
      
      .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
      }
      
      .required {
        color: #f44336;
      }
      
      .remove-selected {
        background: none;
        border: none;
        color: #f44336;
        cursor: pointer;
        margin-left: 10px;
      }
      
      .remove-selected:hover {
        color: #d32f2f;
      }
      
      .text-muted {
        color: #666;
        font-style: italic;
        text-align: center;
        padding: 20px;
      }
    </style>
  </body>
</html>