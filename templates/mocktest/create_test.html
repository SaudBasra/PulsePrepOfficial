{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PulsePrep - {% if is_edit %}Edit{% else %}Create{% endif %} Mock Test</title>
    <link rel="stylesheet" href="{% static 'css/DAstyles.css' %}" />
    <link rel="stylesheet" href="{% static 'css/mockTest.css' %}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
      .question-selection-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }
      
      .question-pool, .selected-questions {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        height: 500px;
        overflow-y: auto;
      }
      
      .question-item {
        padding: 10px;
        margin: 5px 0;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .question-item:hover {
        background-color: #f5f5f5;
      }
      
      .question-item.selected {
        background-color: #e3f2fd;
        border-color: #2196f3;
      }
      
      .question-item input[type="checkbox"] {
        margin-right: 10px;
      }
      
      .question-meta {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }
      
      .difficulty-easy { color: #4caf50; }
      .difficulty-medium { color: #ff9800; }
      .difficulty-hard { color: #f44336; }
      
      .selection-stats {
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 4px;
        margin-bottom: 10px;
        text-align: center;
      }
      
      .filter-section {
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      
      .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-bottom: 10px;
      }
      
      .hidden { display: none; }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="logo-container">
          <img src="{% static 'Logo.png' %}" alt="PulsePrep Logo" class="logo" />
        </div>
        <nav class="nav-menu">
          <a href="{% url 'dashboard' %}" class="nav-item">
            <i class="fas fa-th-large"></i>
            <span>Dashboard</span>
          </a>
          <a href="{% url 'questionbank' %}" class="nav-item">
            <i class="fas fa-question-circle"></i>
            <span>Manage Questions</span>
          </a>
          <a href="{% url 'managemodule' %}" class="nav-item">
            <i class="fas fa-cubes"></i>
            <span>Modules</span>
          </a>
          <a href="/admin/user_management/customuser/" class="nav-item">
            <i class="fas fa-users"></i>
            <span>Manage Users</span>
          </a>
          <a href="{% url 'mocktest_list' %}" class="nav-item">
            <i class="fas fa-vial"></i>
            <span>Mock Tests</span>
          </a>
          <a href="{% url 'analytics_report' %}" class="nav-item">
            <i class="fas fa-chart-bar"></i>
            <span>Analytics & Reports</span>
          </a>
          <a href="{% url 'myaccount' %}" class="nav-item">
            <i class="fas fa-user"></i>
            <span>My Account</span>
          </a>
          <a href="{% url 'notificationsetting' %}" class="nav-item">
            <i class="fas fa-bell"></i>
            <span>Notification Settings</span>
          </a>
          <a href="{% url 'setting' %}" class="nav-item">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
          </a>
          <a href="{% url 'logout' %}" class="nav-item">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
          </a>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <header class="header">
          <div class="mobile-menu">
            <button id="sidebar-toggle">
              <i class="fas fa-bars"></i>
            </button>
          </div>
          <h1>{% if is_edit %}Edit{% else %}Create{% endif %} Mock Test</h1>
          <div class="user-menu">
            <a href="{% url 'notificationsetting' %}"><i class="fas fa-bell"></i></a>
            <div class="avatar">
              <img src="https://i.pravatar.cc/40?img=12" alt="User Avatar" />
            </div>
          </div>
        </header>

        <!-- Form Content -->
        <div class="dashboard-content">
          <section class="test-form-section">
            <form method="POST" id="mock-test-form">
              {% csrf_token %}
              
              <div class="form-grid">
                <!-- Basic Information -->
                <div class="form-section">
                  <h3 class="form-section-title">Basic Information</h3>
                  
                  <div class="form-group">
                    <label for="id_title">Title of Test <span class="required">*</span></label>
                    {{ form.title }}
                  </div>
                  
                  <div class="form-group">
                    <label for="id_description">Description</label>
                    {{ form.description }}
                  </div>
                  
                  <div class="form-group">
                    <label for="id_instructions">Instructions</label>
                    {{ form.instructions }}
                  </div>
                  
                  <div class="form-row">
                    <div class="form-group">
                      <label for="id_start_datetime">Start Date & Time <span class="required">*</span></label>
                      {{ form.start_datetime }}
                    </div>
                    
                    <div class="form-group">
                      <label for="id_end_datetime">End Date & Time <span class="required">*</span></label>
                      {{ form.end_datetime }}
                    </div>
                  </div>
                  
                  <div class="form-row">
                    <div class="form-group">
                      <label for="id_duration_minutes">Duration (minutes) <span class="required">*</span></label>
                      {{ form.duration_minutes }}
                    </div>
                    
                    <div class="form-group">
                      <label for="id_max_attempts">Max Attempts</label>
                      {{ form.max_attempts }}
                    </div>
                  </div>
                  
                  <div class="form-row">
                    <div class="form-group">
                      <label for="id_passing_percentage">Passing Percentage</label>
                      {{ form.passing_percentage }}
                    </div>
                    
                    <div class="form-group">
                      <label for="id_status">Status</label>
                      {{ form.status }}
                    </div>
                  </div>
                </div>
                
                <!-- Test Classification -->
                <div class="form-section">
                  <h3 class="form-section-title">Test Classification</h3>
                  
                  <div class="form-group">
                    <label for="id_degree">Degree</label>
                    {{ form.degree }}
                  </div>
                  
                  <div class="form-group">
                    <label for="id_year">Year</label>
                    {{ form.year }}
                  </div>
                  
                  <div class="form-group">
                    <label for="id_block">Block</label>
                    <select id="id_block" name="block" class="form-control">
                      <option value="">Select Block</option>
                      {% for block in blocks %}
                        <option value="{{ block.block }}" {% if form.block.value == block.block %}selected{% endif %}>{{ block.block }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="id_module">Module</label>
                    <select id="id_module" name="module" class="form-control">
                      <option value="">Select Module</option>
                      {% for module in modules %}
                        <option value="{{ module.module }}" {% if form.module.value == module.module %}selected{% endif %}>{{ module.module }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="id_subject">Subject</label>
                    <select id="id_subject" name="subject" class="form-control">
                      <option value="">Select Subject</option>
                      {% for subject in subjects %}
                        <option value="{{ subject.subject }}" {% if form.subject.value == subject.subject %}selected{% endif %}>{{ subject.subject }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="id_topic">Topic</label>
                    <select id="id_topic" name="topic" class="form-control">
                      <option value="">Select Topic</option>
                      {% for topic in topics %}
                        <option value="{{ topic.topic }}" {% if form.topic.value == topic.topic %}selected{% endif %}>{{ topic.topic }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                
                <!-- Question Configuration -->
                <div class="form-section">
                  <h3 class="form-section-title">Question Configuration</h3>
                  
                  <div class="form-group">
                    <label for="id_total_questions">Total Questions <span class="required">*</span></label>
                    {{ form.total_questions }}
                  </div>
                  
                  <div class="form-group">
                    <label>Question Selection Type <span class="required">*</span></label>
                    <div class="radio-group">
                      {% for radio in form.selection_type %}
                        <label class="radio-label">
                          {{ radio.tag }}
                          <span>{{ radio.choice_label }}</span>
                        </label>
                      {% endfor %}
                    </div>
                  </div>
                  
                  <!-- Random Selection Options -->
                  <div id="random-options" class="{% if form.selection_type.value != 'random' %}hidden{% endif %}">
                    <div class="form-row">
                      <div class="form-group">
                        <label for="id_easy_percentage">Easy %</label>
                        {{ form.easy_percentage }}
                      </div>
                      
                      <div class="form-group">
                        <label for="id_medium_percentage">Medium %</label>
                        {{ form.medium_percentage }}
                      </div>
                      
                      <div class="form-group">
                        <label for="id_hard_percentage">Hard %</label>
                        {{ form.hard_percentage }}
                      </div>
                    </div>
                    <small class="text-muted">Note: Percentages must sum to 100%</small>
                  </div>
                  
                  <!-- Manual Selection Button -->
                  <div id="manual-options" class="{% if form.selection_type.value != 'manual' %}hidden{% endif %}">
                    <button type="button" class="action-button" id="select-questions-btn">
                      <i class="fas fa-list"></i> Select Questions
                    </button>
                    <div class="selection-stats">
                      <span id="selected-count">0</span> questions selected
                    </div>
                  </div>
                  
                  <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                      {{ form.randomize_questions }} <span>Randomize Questions</span>
                    </label>
                    <label class="checkbox-label">
                      {{ form.randomize_options }} <span>Randomize Options</span>
                    </label>
                    <label class="checkbox-label">
                      {{ form.show_explanations }} <span>Show Explanations</span>
                    </label>
                  </div>
                </div>
              </div>
              
              <!-- Form Actions -->
              <div class="form-actions">
                <a href="{% url 'mocktest_list' %}" class="action-button secondary">Cancel</a>
                {% if test %}
                  <a href="{% url 'preview_test' test.id %}" class="action-button">Preview</a>
                {% endif %}
                <button type="submit" class="action-button primary">
                  {% if is_edit %}Update{% else %}Create{% endif %} Test
                </button>
              </div>
            </form>
          </section>
        </div>
      </main>
    </div>

    <!-- Manual Question Selection Modal -->
    <div id="question-selection-modal" class="modal hidden">
      <div class="modal-content" style="max-width: 90%; width: 1200px;">
        <div class="modal-header">
          <h3>Select Questions</h3>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <!-- Filters -->
          <div class="filter-section">
            <div class="filter-row">
              <select id="filter-degree" class="form-control">
                <option value="">All Degrees</option>
                <option value="MBBS">MBBS</option>
                <option value="BDS">BDS</option>
              </select>
              
              <select id="filter-year" class="form-control">
                <option value="">All Years</option>
                <option value="1st">1st</option>
                <option value="2nd">2nd</option>
                <option value="3rd">3rd</option>
                <option value="4th">4th</option>
                <option value="5th">5th</option>
              </select>
              
              <select id="filter-block" class="form-control">
                <option value="">All Blocks</option>
              </select>
              
              <select id="filter-module" class="form-control">
                <option value="">All Modules</option>
              </select>
              
              <select id="filter-subject" class="form-control">
                <option value="">All Subjects</option>
              </select>
              
              <select id="filter-topic" class="form-control">
                <option value="">All Topics</option>
              </select>
              
              <button id="apply-filters" class="action-button primary">
                <i class="fas fa-filter"></i> Apply Filters
              </button>
            </div>
          </div>
          
          <!-- Question Selection -->
          <div class="question-selection-container">
            <div class="question-pool">
              <h4>Available Questions</h4>
              <div class="selection-stats">
                <button id="select-all" class="action-button">Select All</button>
                <button id="clear-all" class="action-button">Clear All</button>
              </div>
              <div id="available-questions"></div>
            </div>
            
            <div class="selected-questions">
              <h4>Selected Questions (<span id="selected-total">0</span>)</h4>
              <div id="selected-questions-list"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="action-button secondary close-modal">Cancel</button>
          <button id="save-selection" class="action-button primary">Save Selection</button>
        </div>
      </div>
    </div>

    <script src="{% static 'js/DAscript.js' %}"></script>
    <script>
      let selectedQuestions = new Set();
      {% if test %}
        // If editing, load existing questions
        {% for tq in test.testquestion_set.all %}
          selectedQuestions.add({{ tq.question.id }});
        {% endfor %}
      {% endif %}
      
      // Update selected count
      document.getElementById('selected-count').textContent = selectedQuestions.size;
      
      // Selection type toggle
      document.querySelectorAll('input[name="selection_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.value === 'random') {
            document.getElementById('random-options').classList.remove('hidden');
            document.getElementById('manual-options').classList.add('hidden');
          } else {
            document.getElementById('random-options').classList.add('hidden');
            document.getElementById('manual-options').classList.remove('hidden');
          }
        });
      });
      
      // Dynamic dropdowns
      const degreeSelect = document.getElementById('id_degree');
      const yearSelect = document.getElementById('id_year');
      const blockSelect = document.getElementById('id_block');
      const moduleSelect = document.getElementById('id_module');
      const subjectSelect = document.getElementById('id_subject');
      const topicSelect = document.getElementById('id_topic');
      
      function updateDropdowns(changedField) {
        const degree = degreeSelect.value;
        const year = yearSelect.value;
        const block = blockSelect.value;
        const module = moduleSelect.value;
        const subject = subjectSelect.value;
        
        // Update blocks
        if (changedField === 'degree' || changedField === 'year') {
          fetch(`{% url 'get_hierarchy_data' %}?field=blocks&degree=${degree}&year=${year}`)
            .then(response => response.json())
            .then(data => {
              blockSelect.innerHTML = '<option value="">Select Block</option>';
              data.data.forEach(item => {
                blockSelect.innerHTML += `<option value="${item}">${item}</option>`;
              });
            });
        }
        
        // Update modules
        if (changedField === 'block' || changedField === 'degree' || changedField === 'year') {
          fetch(`{% url 'get_hierarchy_data' %}?field=modules&degree=${degree}&year=${year}&block=${block}`)
            .then(response => response.json())
            .then(data => {
              moduleSelect.innerHTML = '<option value="">Select Module</option>';
              data.data.forEach(item => {
                moduleSelect.innerHTML += `<option value="${item}">${item}</option>`;
              });
            });
        }
        
        // Update subjects
        if (changedField === 'module' || changedField === 'block') {
          fetch(`{% url 'get_hierarchy_data' %}?field=subjects&degree=${degree}&year=${year}&block=${block}&module=${module}`)
            .then(response => response.json())
            .then(data => {
              subjectSelect.innerHTML = '<option value="">Select Subject</option>';
              data.data.forEach(item => {
                subjectSelect.innerHTML += `<option value="${item}">${item}</option>`;
              });
            });
        }
        
        // Update topics
        if (changedField === 'subject' || changedField === 'module') {
          fetch(`{% url 'get_hierarchy_data' %}?field=topics&degree=${degree}&year=${year}&block=${block}&module=${module}&subject=${subject}`)
            .then(response => response.json())
            .then(data => {
              topicSelect.innerHTML = '<option value="">Select Topic</option>';
              data.data.forEach(item => {
                topicSelect.innerHTML += `<option value="${item}">${item}</option>`;
              });
            });
        }
      }
      
      degreeSelect.addEventListener('change', () => updateDropdowns('degree'));
      yearSelect.addEventListener('change', () => updateDropdowns('year'));
      blockSelect.addEventListener('change', () => updateDropdowns('block'));
      moduleSelect.addEventListener('change', () => updateDropdowns('module'));
      subjectSelect.addEventListener('change', () => updateDropdowns('subject'));
      
      // Manual question selection
      const modal = document.getElementById('question-selection-modal');
      const selectQuestionsBtn = document.getElementById('select-questions-btn');
      const closeModalBtns = document.querySelectorAll('.close-modal');
      
      selectQuestionsBtn.addEventListener('click', function() {
        modal.classList.remove('hidden');
        loadQuestions();
      });
      
      closeModalBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          modal.classList.add('hidden');
        });
      });
      
      // Load questions for manual selection
      function loadQuestions() {
        const filters = {
          degree: document.getElementById('filter-degree').value,
          year: document.getElementById('filter-year').value,
          block: document.getElementById('filter-block').value,
          module: document.getElementById('filter-module').value,
          subject: document.getElementById('filter-subject').value,
          topic: document.getElementById('filter-topic').value,
        };
        
        const queryString = Object.entries(filters)
          .filter(([key, value]) => value)
          .map(([key, value]) => `${key}=${encodeURIComponent(value)}`)
          .join('&');
        
        fetch(`{% url 'get_filtered_questions' %}?${queryString}`)
          .then(response => response.json())
          .then(data => {
            const container = document.getElementById('available-questions');
            container.innerHTML = '';
            
            data.questions.forEach(question => {
              const isSelected = selectedQuestions.has(question.id);
              const div = document.createElement('div');
              div.className = `question-item ${isSelected ? 'selected' : ''}`;
              div.innerHTML = `
                <label>
                  <input type="checkbox" value="${question.id}" ${isSelected ? 'checked' : ''}>
                  <span>${question.text}</span>
                </label>
                <div class="question-meta">
                  <span class="difficulty-${question.difficulty.toLowerCase()}">${question.difficulty}</span> | 
                  ${question.module} | ${question.subject} | ${question.topic}
                </div>
              `;
              
              div.querySelector('input').addEventListener('change', function() {
                if (this.checked) {
                  selectedQuestions.add(question.id);
                  div.classList.add('selected');
                } else {
                  selectedQuestions.delete(question.id);
                  div.classList.remove('selected');
                }
                updateSelectedDisplay();
              });
              
              container.appendChild(div);
            });
            
            updateSelectedDisplay();
          });
      }
      
      // Update selected questions display
      function updateSelectedDisplay() {
        document.getElementById('selected-total').textContent = selectedQuestions.size;
        document.getElementById('selected-count').textContent = selectedQuestions.size;
        
        // Update the total questions field
        if (document.querySelector('input[name="selection_type"]:checked').value === 'manual') {
          document.getElementById('id_total_questions').value = selectedQuestions.size;
        }
      }
      
      // Select all / Clear all
      document.getElementById('select-all').addEventListener('click', function() {
        document.querySelectorAll('#available-questions input[type="checkbox"]').forEach(cb => {
          cb.checked = true;
          selectedQuestions.add(parseInt(cb.value));
          cb.closest('.question-item').classList.add('selected');
        });
        updateSelectedDisplay();
      });
      
      document.getElementById('clear-all').addEventListener('click', function() {
        document.querySelectorAll('#available-questions input[type="checkbox"]').forEach(cb => {
          cb.checked = false;
          selectedQuestions.delete(parseInt(cb.value));
          cb.closest('.question-item').classList.remove('selected');
        });
        updateSelectedDisplay();
      });
      
      // Apply filters
      document.getElementById('apply-filters').addEventListener('click', loadQuestions);
      
      // Save selection
      document.getElementById('save-selection').addEventListener('click', function() {
        if (selectedQuestions.size === 0) {
          alert('Please select at least one question.');
          return;
        }
        
        // Update form field
        document.getElementById('id_total_questions').value = selectedQuestions.size;
        
        // Store selected questions (we'll submit them with the form)
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'selected_questions';
        input.value = JSON.stringify(Array.from(selectedQuestions));
        document.getElementById('mock-test-form').appendChild(input);
        
        modal.classList.add('hidden');
        alert(`${selectedQuestions.size} questions selected`);
      });
      
      // Form submission
      document.getElementById('mock-test-form').addEventListener('submit', function(e) {
        if (document.querySelector('input[name="selection_type"]:checked').value === 'manual' && selectedQuestions.size === 0) {
          e.preventDefault();
          alert('Please select questions for the test.');
          return;
        }
        
        // Add selected questions to form if manual selection
        if (document.querySelector('input[name="selection_type"]:checked').value === 'manual') {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'selected_questions';
          input.value = JSON.stringify(Array.from(selectedQuestions));
          this.appendChild(input);
        }
      });
      
      // Initialize filter dropdowns
      function initializeFilterDropdowns() {
        // Copy main form values to filter dropdowns
        document.getElementById('filter-degree').value = degreeSelect.value;
        document.getElementById('filter-year').value = yearSelect.value;
        
        // Load hierarchy data for filters
        fetch(`{% url 'get_hierarchy_data' %}?field=blocks`)
          .then(response => response.json())
          .then(data => {
            const filterBlock = document.getElementById('filter-block');
            filterBlock.innerHTML = '<option value="">All Blocks</option>';
            data.data.forEach(item => {
              filterBlock.innerHTML += `<option value="${item}">${item}</option>`;
            });
          });
      }
      
      selectQuestionsBtn.addEventListener('click', initializeFilterDropdowns);
    </script>

    <style>
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      
      .modal.hidden {
        display: none;
      }
      
      .modal-content {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        max-height: 90vh;
        overflow-y: auto;
      }
      
      .modal-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .modal-body {
        padding: 20px;
      }
      
      .modal-footer {
        padding: 20px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }
      
      .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
      }
      
      .required {
        color: #f44336;
      }
    </style>
  </body>
</html>